pkgname=mingw-w64-i686-smg
pkgver=1.0.0
pkgrel=1
pkgdesc="SMG programming language â€” LuaJIT-based x86-only compiler that outputs NASM machine code"
arch=('any')
url="https://github.com/grzegorzchwal80-glitch/SMG-language"
license=('GPL3')
mingw_arch=('mingw32')

depends=(
  'mingw-w64-i686-nasm'
)

makedepends=(
  'mingw-w64-i686-gcc'
  'mingw-w64-i686-make'
)

source=("https://github.com/grzegorzchwal80-glitch/SMG-language/archive/refs/tags/${pkgver}.tar.gz")
sha256sums=('SKIP')

build() {
  cd "$srcdir/SMG-language-${pkgver}/SMGcompiler"

  # Build LuaJIT static
  cd JIT/src
  mingw32-make clean
  mingw32-make BUILDMODE=static CC="i686-w64-mingw32-gcc"
  cd ../..

  # Build SMGcompiler
  i686-w64-mingw32-gcc SMGcompiler.luastatic.c \
    -o SMGcompiler.exe \
    JIT/src/libluajit.a \
    -I JIT/src \
    -lwinmm -lpsapi
}

package() {
  cd "$srcdir/SMG-language-${pkgver}/SMGcompiler"

  install -Dm755 SMGcompiler.exe "$pkgdir/mingw32/bin/SMG.exe"

  install -d "$pkgdir/mingw32/lib/smg"
  cp -r JIT *.lua *.smglib "$pkgdir/mingw32/lib/smg/" 2>/dev/null || true
}