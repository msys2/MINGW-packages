_realname=SmallBASIC
pkgbase=mingw-w64-smallbasic
pkgname="${MINGW_PACKAGE_PREFIX}-smallbasic"
pkgver=12.26
pkgrel=1
pkgdesc="SmallBASIC is a fast and easy to learn BASIC language interpreter (mingw-w64)"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32')
url="https://smallbasic.github.io/"
license=('spdx:GPL-3.0-or-later')
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs"
         "${MINGW_PACKAGE_PREFIX}-SDL2"
         "${MINGW_PACKAGE_PREFIX}-libmicrohttpd")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc" "${MINGW_PACKAGE_PREFIX}-autotools" vim)
options=('strip')
source=("https://github.com/smallbasic/SmallBASIC/releases/download/${pkgver}/smallbasic-${pkgver}.tar.gz"
        0001-link-everything-dynamically.patch)
sha256sums=('eb5e9fef69f35bd380f629b400ec36951d8223b4ca2970ef4f2f57b3bfe01f9e'
            '320fcd65425e20d95110ff5461acdaea56d4aa855c94286100267e1c3078779b')

prepare() {
  cd "${srcdir}"/smallbasic-${pkgver}
  patch -p0 -i ${srcdir}/0001-link-everything-dynamically.patch
  autoreconf -fvi
}

build() {
  [[ -d ${srcdir}/build-${MSYSTEM} ]] && rm -rf ${srcdir}/build-${MSYSTEM}
  cp -rf smallbasic-${pkgver} build-${MSYSTEM} && cd build-${MSYSTEM}

# configure and build multiple times to build all versions of SmallBASIC
# so far we build the console version, the sdl version, and the web server version
# these are what included in a SmallBASIC release
# there are other versions like the fltk version, but we don't build them

# build console version
  ./configure \
    --prefix=${MINGW_PREFIX} \
    --host=${MINGW_CHOST} \
    --target=${MINGW_CHOST} \
    --build=${MINGW_CHOST} \

  make

  make DESTDIR="${pkgdir}" install

# build sdl version
  ./configure \
    --prefix=${MINGW_PREFIX} \
    --host=${MINGW_CHOST} \
    --target=${MINGW_CHOST} \
    --build=${MINGW_CHOST} \
    --enable-sdl

  make

  make DESTDIR="${pkgdir}" install

# build web server version
  ./configure \
    --prefix=${MINGW_PREFIX} \
    --host=${MINGW_CHOST} \
    --target=${MINGW_CHOST} \
    --build=${MINGW_CHOST} \
    --enable-web

  make

  make DESTDIR="${pkgdir}" install
}

package() {
  cd ${srcdir}/build-${MSYSTEM}
  # do nothing as we have moved make DESTDIR="${pkgdir}" install into the build step
}
