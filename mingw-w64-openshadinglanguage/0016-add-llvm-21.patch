diff --git a/src/cmake/externalpackages.cmake b/src/cmake/externalpackages.cmake
index 819a6cf..8fff2f3 100644
--- a/src/cmake/externalpackages.cmake
+++ b/src/cmake/externalpackages.cmake
@@ -58,7 +58,7 @@ checked_find_package (pugixml REQUIRED
 # LLVM library setup
 checked_find_package (LLVM REQUIRED
                       VERSION_MIN 11.0
-                      VERSION_MAX 20.9
+                      VERSION_MAX 21.9
                       PRINT LLVM_SYSTEM_LIBRARIES CLANG_LIBRARIES
                             LLVM_SHARED_MODE)
 # ensure include directory is added (in case of non-standard locations
diff --git a/src/liboslcomp/oslcomp.cpp b/src/liboslcomp/oslcomp.cpp
index 14bee9a..45e743f 100644
--- a/src/liboslcomp/oslcomp.cpp
+++ b/src/liboslcomp/oslcomp.cpp
@@ -169,7 +169,7 @@ OSLCompilerImpl::preprocess_buffer(const std::string& buffer,
     // Set up error capture for the preprocessor
     std::string preproc_errors;
     llvm::raw_string_ostream errstream(preproc_errors);
-    clang::DiagnosticOptions* diagOptions = new clang::DiagnosticOptions();
+    clang::DiagnosticOptions diagOptions;
     clang::TextDiagnosticPrinter* diagPrinter
         = new clang::TextDiagnosticPrinter(errstream, diagOptions);
     llvm::IntrusiveRefCntPtr<clang::DiagnosticIDs> diagIDs(
@@ -178,9 +178,8 @@ OSLCompilerImpl::preprocess_buffer(const std::string& buffer,
         = new clang::DiagnosticsEngine(diagIDs, diagOptions, diagPrinter);
     inst.setDiagnostics(diagEngine);
 
-    const std::shared_ptr<clang::TargetOptions> targetopts
-        = std::make_shared<clang::TargetOptions>(inst.getTargetOpts());
-    targetopts->Triple = llvm::sys::getDefaultTargetTriple();
+    clang::TargetOptions targetopts = inst.getTargetOpts();
+    targetopts.Triple = llvm::sys::getDefaultTargetTriple();
     clang::TargetInfo* target
         = clang::TargetInfo::CreateTargetInfo(inst.getDiagnostics(),
                                               targetopts);
