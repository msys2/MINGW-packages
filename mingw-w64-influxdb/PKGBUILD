# Contributor: Liu Pak Hin <wl@m-labs.hk>

_realname=influxdb
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.8.10
pkgrel=1
pkgdesc="An open-source distributed time series database"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32')
url="https://www.influxdata.com/"
license=('MIT')
makedepends=("${MINGW_PACKAGE_PREFIX}-go"
             "git"
             "${MINGW_PACKAGE_PREFIX}-rust"
             "${MINGW_PACKAGE_PREFIX}-clang"
             "${MINGW_PACKAGE_PREFIX}-llvm"
             "${MINGW_PACKAGE_PREFIX}-protobuf"
             "${MINGW_PACKAGE_PREFIX}-pkg-config"
             )
source=("https://github.com/influxdata/influxdb/archive/refs/tags/v${pkgver}.tar.gz")
sha256sums=('SKIP')

prepare() {
  cd ${srcdir}

  #sed -i "s/Linux/Linux | $(uname -s)/g" scripts/fetch-ui-assets.sh
  # sed -i "s|\/usr\/bin\/env bash|\/bin\/sh|g" scripts/pkg-config.sh
  # chmod ugo+x ${srcdir}/${_realname}-$pkgver/scripts/pkg-config.sh 
  # sed -i "s/\$(PWD)\/scripts/${srcdir}\/influxdb-$pkgver\/scripts/g" GNUmakefile
  # sed -i "s/export GOOS=\$(shell go env GOOS)/export GOOS=windows/g" GNUmakefile
  # sed -i "s/export GOARCH=\$(shell go env GOARCH)/export GOARCH=amd64/g" GNUmakefile
  # sed -i "s/pkg-config.sh/pkg-config.sh.exe/g" GNUmakefile
  # mv scripts/pkg-config.sh scripts/pkg-config.sh.exe
}

build() {
  cd ${srcdir}/${_realname}-$pkgver
  go clean ./...
  go install ./...
  # export GOFLAGS="-trimpath -mod=readonly -modcacherw"
  # export LDFLAGS=""
  # go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
  # PKG_CONFIG=${MINGW_PREFIX}/bin/pkgconf \
  # make -j1 VERSION=$pkgver COMMIT=$_commit_sha INFLUXDB_SHA=$_commit_sha
}

# check() {
#   cd ${srcdir}/${_realname}-$pkgver
#   PATH="$(go env GOPATH)/bin:$PATH" make test || true
# }

package() {
  cd ${srcdir}/${_realname}-$pkgver
  #install -Dm644 ../influxdb.service -t "${pkgdir}/usr/lib/systemd/system"
  cp $(go env GOPATH)/bin/influxd.exe "${pkgdir}/usr/bin/influxd.exe"
  install -Dm644 LICENSE -t "${pkgdir}/usr/share/licenses/influxdb"
}
