# Contributor: Liu Pak Hin <wl@m-labs.hk>

_realname=influxdb
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2.4.0
pkgrel=1
pkgdesc="An open-source distributed time series database"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32')
url="https://www.influxdata.com/"
license=('MIT')
makedepends=("${MINGW_PACKAGE_PREFIX}-go"
             "git"
             "${MINGW_PACKAGE_PREFIX}-clang"
             "${MINGW_PACKAGE_PREFIX}-llvm"
             "${MINGW_PACKAGE_PREFIX}-protobuf"
             "${MINGW_PACKAGE_PREFIX}-pkg-config"
             )
source=("https://github.com/influxdata/influxdb/archive/refs/tags/v${pkgver}.tar.gz")
sha256sums=('SKIP')

prepare() {
  cd ${srcdir}/${_realname}-$pkgver

  sed -i "s/Linux/Linux | $(uname -s)/g" scripts/fetch-ui-assets.sh
}

build() {
  cd ${srcdir}/${_realname}-$pkgver
  export GOFLAGS="-trimpath -mod=readonly -modcacherw"
  export LDFLAGS=""
  go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
  PATH="$(go env GOPATH)/bin:$PATH" make -j1 VERSION=$pkgver COMMIT=$_commit_sha INFLUXDB_SHA=$_commit_sha
}

check() {
  cd "$pkgname"
  PATH="$(go env GOPATH)/bin:$PATH" make test || true
}

package() {
  cd ${srcdir}/${_realname}-$pkgver
  install -Dm644 ../influxdb.service -t "${pkgdir}/usr/lib/systemd/system"
  install -Dm755 bin/linux/influxd -t "${pkgdir}/usr/bin"
  install -Dm644 LICENSE -t "${pkgdir}/usr/share/licenses/influxdb"
}
