_realname=fswatch
pkgbase=mingw-w64-${_realname}
pkgname=${MINGW_PACKAGE_PREFIX}-${_realname}
pkgver=1.17.1.r36.gba411e0
pkgrel=1
_branch=master
pkgdesc="A cross-platform file change monitor with multiple backends: Apple OS X File System Events API, *BSD kqueue, Linux inotify, Microsoft Windows and a stat-based backend (mingw-w64)"
arch=('any')
mingw_arch=('mingw64' 'ucrt64')
license=('GPL-3.0-only WITH GCC-exception-3.1')
url="https://github.com/emcrisostomo/fswatch"
makedepends=()
depends=()
source=("git+https://github.com/emcrisostomo/fswatch.git#branch=${_branch}"
        'fix-for-msys2.patch')
sha256sums=('SKIP'
            '3abd89fa8a9a0a9c1f5f10dc9c14785d262d3918886e2a598ad70472e97b755d')

pkgver() {
  cd "${_realname}"
  git describe --long --tags --abbrev=7 | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "${srcdir}/${_realname}"
  patch -p1 -i ${srcdir}/fix-for-msys2.patch
  # NOCONFIGURE=1 ./autogen.sh
}

build() {
  [[ -d ${srcdir}/build-${MINGW_CHOST} ]] && rm -rf ${srcdir}/build-${MINGW_CHOST}
  mkdir -p "${srcdir}/build-${MINGW_CHOST}" && cd "${srcdir}/build-${MINGW_CHOST}"
  # ../${_realname}/configure \
  #   --prefix=${MINGW_PREFIX} \
  #   --build=${MINGW_CHOST} \
  #   --host=${MINGW_CHOST} \
  #   --enable-static \
  #   --enable-shared
  # mv libtool libtool.bak && sed -e "s/\(allow_undefined=\)yes/\1no/" libtool.bak > libtool && chmod +x libtool
  # make V=1

  ${MINGW_PREFIX}/bin/cmake -B "${srcdir}/build-${MINGW_CHOST}" -S "${srcdir}/${_realname}" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
  ${MINGW_PREFIX}/bin/cmake --build "${srcdir}/build-${MINGW_CHOST}" --config Release

  #############################################################################
  # FIXME: Linking to libintl failed
  #
  # [link]         lsp-ada_driver.adb
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x1103): undefined reference to `libintl_gettext'
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x1450): undefined reference to `libintl_gettext'
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x158c): undefined reference to `libintl_gettext'
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x1868): undefined reference to `libintl_gettext'
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x3a91): undefined reference to `libintl_gettext'
  # C:/Users/User/scoop/apps/msys2/2023-10-26/ucrt64/bin/../lib/gcc/x86_64-w64-mingw32/13.2.0/../../../../x86_64-w64-mingw32/bin/ld.exe: C:\users\user\scoop\apps\ms):(.text+0x4388): more undefined references to `libintl_gettext' follow
  # collect2.exe: error: ld returned 1 exit status
  # gprbuild: link of lsp-ada_driver.adb failed
  # gprbuild: failed command was: C:\Users\User\scoop\apps\msys2\2023-10-26\ucrt64\bin\g++.exe lsp-ada_driver.o C:\Users\User\scoop\apps\msys2\2023-10-26\tmp\GNAT-T64\lib\spawn\libspawn.a -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\vss\relocatable\ -lvss-regexp C:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\li2023-10-26\ucrt64\lib\lal_refactor.relocatable\ -llal-refactor -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\lal_tools.relocatable\ -llal_tools -LC:\usser.relocatable\ -ltemplates_parser -lvss-json -lvss -lvss-gnat -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\libadalang.relocatable\ -ladalang -LC:\usrt.relocatable\ -llangkit_support -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\adasat.relocatable\ -ladasat -LC:\users\user\scoop\apps\msys2\2023-10-2pps\msys2\2023-10-26\ucrt64\lib\gnatcoll_iconv.relocatable\ -lgnatcoll_iconv -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\ -liconv -LC:\users\user\sco -lgnatcoll_gmp -lgmp -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\gnatcoll.relocatable\ -lgnatcoll -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64ys2\2023-10-26\ucrt64\lib\xmlada\xmlada_schema.relocatable\ -lxmlada_schema -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\xmlada\xmlada_dom.relocatablert64\lib\xmlada\xmlada_sax.relocatable\ -lxmlada_sax -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\xmlada\xmlada_input.relocatable\ -lxmlada_input_sourlada\xmlada_unicode.relocatable\ -lxmlada_unicode -Lc:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\ -liconv -lgmp -DHAVE_WINDOWS -Lc:\users\user\scoop\appscoop\apps\msys2\2023-10-26\ucrt64\lib\ -liconv -lgmp -luserenv -Lc:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\ -liconv -lgmp -Lc:\users\user\scoop\appscoop\apps\msys2\2023-10-26\ucrt64\lib\ -lgmp -liconv -liconv -lgmp -lpsapi -lntdll -LC:\Users\User\scoop\persist\msys2\home\User\ada-packages\new-packages\mingw -LC:\Users\User\scoop\persist\msys2\home\User\ada-packages\new-packages\mingw-w64-ada_language_server\src\ada_language_server\.obj\server\ -LC:\users\user\scoors\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\gnatcoll_gmp.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\gpr\relocatable\gpr\ -LC:\users\ema.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\xmlada\xmlada_sax.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\xmsys2\2023-10-26\ucrt64\lib\xmlada\xmlada_input.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\xmlada\xmlada_dom.relocatable\ -LC:\users\use\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\gnatcoll_iconv.relocatable\ -LC:\users\user\scoLC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\adasat.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\langkit_support.relocatable\ -Ls.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\vss\relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\templates_parser.r4\lib\lal_refactor.relocatable\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\ada_libfswatch\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\c_4\lib\libgnatdoc\ -LC:\users\user\scoop\apps\msys2\2023-10-26\ucrt64\lib\spawn\ -LC:\Users\User\scoop\persist\msys2\home\User\ada-packages\new-packages\mingw-w6users/user/scoop/apps/msys2/2023-10-26/ucrt64/lib/gcc/x86_64-w64-mingw32/13.2.0/adalib/ -luserenv -luser32 -lshell32 -lkernel32 -ladvapi32 -lgnarl-13 -lgnat-13 ada_language_server.exe
  # make: *** [Makefile:97: all] Error 4
  # ==> ERROR: A failure occurred in build().
  #############################################################################
  # See: https://www.gnu.org/software/gettext/FAQ.html#integrating_undefined
  # Using CMake does something good!?
  #############################################################################
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  # make DESTDIR="${pkgdir}" install
  ${MINGW_PREFIX}/bin/cmake --install "${srcdir}/build-${MINGW_CHOST}" --prefix="${pkgdir}/${MINGW_PREFIX}" --config Release
  install -Dm644 ${srcdir}/${_realname}/COPYING ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/COPYING
}
