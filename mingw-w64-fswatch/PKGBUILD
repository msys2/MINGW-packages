_realname=fswatch
pkgbase=mingw-w64-${_realname}
pkgname=${MINGW_PACKAGE_PREFIX}-${_realname}
pkgver=1.17.1.r36.gba411e0
pkgrel=1
_branch=master
pkgdesc="A cross-platform file change monitor with multiple backends: Apple OS X File System Events API, *BSD kqueue, Linux inotify, Microsoft Windows and a stat-based backend (mingw-w64)"
arch=('any')
mingw_arch=('mingw64' 'ucrt64')
license=('GPL-3.0-only WITH GCC-exception-3.1')
url="https://github.com/emcrisostomo/fswatch"
makedepends=()
depends=()
source=("${_realname}-git::git+https://github.com/emcrisostomo/fswatch.git#branch=${_branch}"
        'fix-for-msys2.patch')
sha256sums=('SKIP'
            '3abd89fa8a9a0a9c1f5f10dc9c14785d262d3918886e2a598ad70472e97b755d')

pkgver() {
  cd "${_realname}"
  git describe --long --tags --abbrev=7 | sed 's/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "${srcdir}/${_realname}-git"
  patch -p1 -i ${srcdir}/fix-for-msys2.patch
}

build() {
  [[ -d ${srcdir}/build-${MINGW_CHOST} ]] && rm -rf ${srcdir}/build-${MINGW_CHOST}
  mkdir -p "${srcdir}/build-${MINGW_CHOST}" && cd "${srcdir}/build-${MINGW_CHOST}"

  ${MINGW_PREFIX}/bin/cmake -B "${srcdir}/build-${MINGW_CHOST}" -S "${srcdir}/${_realname}-git" -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON
  ${MINGW_PREFIX}/bin/cmake --build "${srcdir}/build-${MINGW_CHOST}" --config Release
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  ${MINGW_PREFIX}/bin/cmake --install "${srcdir}/build-${MINGW_CHOST}" --prefix="${pkgdir}/${MINGW_PREFIX}" --config Release
  install -Dm644 ${srcdir}/${_realname}-git/COPYING ${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/COPYING
}
