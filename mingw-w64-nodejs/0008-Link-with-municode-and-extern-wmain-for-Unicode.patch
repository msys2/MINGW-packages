From beb2aade662e0f85beba5e1a721a9fa5b706b4e7 Mon Sep 17 00:00:00 2001
From: Alethea Rose <alethea@alethearose.com>
Date: Wed, 15 Feb 2017 19:11:53 -0500
Subject: [PATCH 08/13] Link with -municode and extern wmain for Unicode

---
 node.gypi        | 3 ++-
 src/node_main.cc | 9 +++++++++
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/node.gypi b/node.gypi
index 4774fff3..33e12f34 100644
--- a/node.gypi
+++ b/node.gypi
@@ -264,8 +264,9 @@
         # we need to use node's preferred "win32" rather than gyp's preferred "win"
         'NODE_PLATFORM="win32"',
         '_UNICODE=1',
+	'UNICODE',
       ],
-      'libraries': [ '-lpsapi' ]
+      'libraries': [ '-municode', '-lpsapi' ]
     }, { # POSIX
       'defines': [ '__POSIX__' ],
       'sources': [ 'src/backtrace_posix.cc' ],
diff --git a/src/node_main.cc b/src/node_main.cc
index bde39756..85c5c48c 100644
--- a/src/node_main.cc
+++ b/src/node_main.cc
@@ -3,6 +3,10 @@
 #ifdef _WIN32
 #include <VersionHelpers.h>
 
+#if defined(__MINGW_VERSION_MAJOR)
+#extern "C" {
+#endif
+
 int wmain(int argc, wchar_t *wargv[]) {
   if (!IsWindows7OrGreater()) {
     fprintf(stderr, "This application is only supported on Windows 7, "
@@ -47,6 +51,11 @@ int wmain(int argc, wchar_t *wargv[]) {
   // Now that conversion is done, we can finally start.
   return node::Start(argc, argv);
 }
+
+#if defined(__MINGW_VERSION_MAJOR)
+}
+#endif
+
 #else
 // UNIX
 int main(int argc, char *argv[]) {
-- 
2.17.0.windows.1

