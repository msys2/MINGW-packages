_realname=Objeck
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2024.3.0
pkgrel=1
_commit=9034f808fda98ec24c839eca3a7aae88ce855953
pkgdesc="Objeck is a modern object-oriented programming language with functional features (mingw-w64)"
arch=('any')
mingw_arch=('ucrt64' 'clang64')
url="https://objeck.org/"
license=('spdx:BSD-3-Clause')
depends=("${MINGW_PACKAGE_PREFIX}-openssl"
         "${MINGW_PACKAGE_PREFIX}-SDL2"
         "${MINGW_PACKAGE_PREFIX}-SDL2_ttf"
         "${MINGW_PACKAGE_PREFIX}-SDL2_mixer"
         "${MINGW_PACKAGE_PREFIX}-SDL2_image"
         "${MINGW_PACKAGE_PREFIX}-unixodbc"
         "${MINGW_PACKAGE_PREFIX}-eigen3")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc"
             $([[ $MINGW_PACKAGE_PREFIX == *-clang-* ]] && echo \
               "${MINGW_PACKAGE_PREFIX}-gcc-compat")
             unzip
             git)
source=("git+https://github.com/objeck/objeck-lang#commit=${_commit}")
sha256sums=('SKIP')

prepare() {
  cd "${srcdir}"/objeck-lang/core/release
}

build() {
  cd "${srcdir}"/objeck-lang/core/release
  if [[ $MINGW_PACKAGE_PREFIX == *-clang-* ]]; then
    ./deploy_msys2-clang.sh
  else
    ./deploy_msys2-ucrt.sh
  fi
}

package() {
  if [[ $MINGW_PACKAGE_PREFIX == *-clang-* ]]; then
    cd "${srcdir}"/objeck-lang/core/release/deploy-msys2-clang
    cp -r bin ${pkgdir}/bin
    mkdir -p ${pkgdir}/share/objeck
    cp -r doc ${pkgdir}/share/objeck/doc
    cp -r examples ${pkgdir}/share/objeck/examples
    cp -r LICENSE ${pkgdir}/share/objeck
    cp -r readme.html ${pkgdir}/share/objeck
    mkdir -p ${pkgdir}/lib
    cp -r lib ${pkgdir}/lib/objeck
  else
    cd "${srcdir}"/objeck-lang/core/release/deploy-msys2-ucrt
    cp -r bin ${pkgdir}/bin
    mkdir -p ${pkgdir}/share/objeck
    cp -r doc ${pkgdir}/share/objeck/doc
    cp -r examples ${pkgdir}/share/objeck/examples
    cp -r LICENSE ${pkgdir}/share/objeck
    cp -r readme.html ${pkgdir}/share/objeck
    cp -r lib ${pkgdir}/lib/objeck
  fi
}
