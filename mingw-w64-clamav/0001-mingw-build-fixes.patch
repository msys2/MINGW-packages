From c06585cfc1a901c04ffa2a9f92b4468e988bf070 Mon Sep 17 00:00:00 2001
From: kreijstal <rainb@tfwno.gf>
Date: Thu, 27 Nov 2025 17:16:38 +0100
Subject: [PATCH] work on msys2

---
 CMakeLists.txt                    |   5 +
 clambc/CMakeLists.txt             |   4 +-
 clamconf/CMakeLists.txt           |   4 +-
 clamconf/clamconf.c               |   2 +-
 clamd/CMakeLists.txt              |   4 +-
 clamdscan/CMakeLists.txt          |   4 +-
 clamdtop/CMakeLists.txt           |   7 +-
 clamscan/CMakeLists.txt           |   4 +-
 clamsubmit/CMakeLists.txt         |   4 +-
 cmake/FindCURSES.cmake            |  54 +++++++--
 cmake/FindPthreadW32.cmake        |   4 +-
 cmake/FindRust.cmake              |  20 +++-
 common/scanmem.h                  |   4 +-
 freshclam/CMakeLists.txt          |   4 +-
 freshclam/freshclam.c             |  11 +-
 libclamav/CMakeLists.txt          |  18 ++-
 libclamav/clamav.h                |   2 +-
 libclamav/crypto.c                | 175 +++++++++++++++++++++++++++---
 libclamav/iowrap.c                |  18 ++-
 libclamav/libclamav_main.c        |  17 +++
 libclamav/matcher.h               |  30 ++---
 libclammspack/CMakeLists.txt      |   4 +-
 libclamunrar/CMakeLists.txt       |   5 +-
 libclamunrar/os.hpp               |   6 +
 libclamunrar_iface/CMakeLists.txt |   4 +-
 libclamunrar_iface/unrar_iface.h  |   8 ++
 libfreshclam/CMakeLists.txt       |   2 +
 libfreshclam/libfreshclam_main.c  |  17 +++
 platform.h.in                     |   4 +
 sigtool/CMakeLists.txt            |   2 +
 win32/compat/gettimeofday.c       |   6 +-
 win32/compat/gettimeofday.h       |   2 +
 win32/compat/net.h                |   2 +-
 33 files changed, 381 insertions(+), 76 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 089a0418f9..b9b8f3bcf4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1042,6 +1042,11 @@ else()
     set(LIBMSPACK "MSPack::mspack")
 endif()
 
+if(WIN32 AND CMAKE_C_COMPILER_ID MATCHES "GNU")
+    set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -Wl,--allow-multiple-definition -Wl,--warn-unresolved-symbols")
+    set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--allow-multiple-definition -Wl,--warn-unresolved-symbols")
+endif()
+
 if(WIN32)
     add_subdirectory( win32/compat )
 endif()
diff --git a/clambc/CMakeLists.txt b/clambc/CMakeLists.txt
index 445c6849b5..64e2fcc7ca 100644
--- a/clambc/CMakeLists.txt
+++ b/clambc/CMakeLists.txt
@@ -38,7 +38,9 @@ target_link_libraries( clambc
         ClamAV::common )
 if(WIN32)
     install(TARGETS clambc DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clambc> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clambc> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS clambc DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/clamconf/CMakeLists.txt b/clamconf/CMakeLists.txt
index 19873ab43a..4117e136a8 100644
--- a/clamconf/CMakeLists.txt
+++ b/clamconf/CMakeLists.txt
@@ -38,7 +38,9 @@ target_link_libraries( clamconf
         ClamAV::common )
 if(WIN32)
     install(TARGETS clamconf DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamconf> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamconf> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS clamconf DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/clamconf/clamconf.c b/clamconf/clamconf.c
index 89f0082c4a..84aa3a0336 100644
--- a/clamconf/clamconf.c
+++ b/clamconf/clamconf.c
@@ -53,7 +53,7 @@
 #include "optparser.h"
 #include "misc.h"
 
-#ifndef _WIN32
+#ifndef _MSC_VER
 extern const struct clam_option *clam_options;
 #else
 __declspec(dllimport) extern const struct clam_option *clam_options;
diff --git a/clamd/CMakeLists.txt b/clamd/CMakeLists.txt
index 0ad1050652..20dee3097e 100644
--- a/clamd/CMakeLists.txt
+++ b/clamd/CMakeLists.txt
@@ -54,7 +54,9 @@ target_link_libraries( clamd
         ClamAV::common )
 if(WIN32)
     install(TARGETS clamd DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamd> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamd> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS clamd DESTINATION ${CMAKE_INSTALL_SBINDIR} COMPONENT programs)
 endif()
diff --git a/clamdscan/CMakeLists.txt b/clamdscan/CMakeLists.txt
index 048bb16c53..b870399bfa 100644
--- a/clamdscan/CMakeLists.txt
+++ b/clamdscan/CMakeLists.txt
@@ -43,7 +43,9 @@ target_link_libraries( clamdscan
         ClamAV::common )
 if(WIN32)
     install(TARGETS clamdscan DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamdscan> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamdscan> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS clamdscan DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/clamdtop/CMakeLists.txt b/clamdtop/CMakeLists.txt
index fafc2bfe58..909c20a5b3 100644
--- a/clamdtop/CMakeLists.txt
+++ b/clamdtop/CMakeLists.txt
@@ -39,7 +39,9 @@ target_link_libraries( clamdtop
         Curses::curses )
 if(WIN32)
     install(TARGETS clamdtop DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamdtop> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamdtop> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
     # Also install shared library (DLL) dependencies
     install(CODE [[
         file(GET_RUNTIME_DEPENDENCIES
@@ -48,7 +50,8 @@ if(WIN32)
             RESOLVED_DEPENDENCIES_VAR _r_deps
             UNRESOLVED_DEPENDENCIES_VAR _u_deps
             DIRECTORIES
-                $<TARGET_FILE_DIR:Curses::curses>
+                ${CMAKE_BINARY_DIR}/bin
+                ${CMAKE_BINARY_DIR}
             POST_EXCLUDE_REGEXES
                 "[cC]:[\\/][wW][iI][nN][dD][oO][wW][sS]"
         )
diff --git a/clamscan/CMakeLists.txt b/clamscan/CMakeLists.txt
index 64608c0df7..30ce7dfe8a 100644
--- a/clamscan/CMakeLists.txt
+++ b/clamscan/CMakeLists.txt
@@ -42,7 +42,9 @@ target_link_libraries( clamscan
         ClamAV::common )
 if(WIN32)
     install(TARGETS clamscan DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamscan> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamscan> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS clamscan DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/clamsubmit/CMakeLists.txt b/clamsubmit/CMakeLists.txt
index 62b2630776..caa2296b3c 100644
--- a/clamsubmit/CMakeLists.txt
+++ b/clamsubmit/CMakeLists.txt
@@ -48,7 +48,9 @@ if(APPLE)
 endif()
 if(WIN32)
     install(TARGETS clamsubmit DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:clamsubmit> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:clamsubmit> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
     # Also install shared library (DLL) dependencies
     install(CODE [[
         file(GET_RUNTIME_DEPENDENCIES
diff --git a/cmake/FindCURSES.cmake b/cmake/FindCURSES.cmake
index 3fc61fbe87..1005717ce0 100644
--- a/cmake/FindCURSES.cmake
+++ b/cmake/FindCURSES.cmake
@@ -48,7 +48,7 @@ The following cache variables may also be set:
 if(NOT NCURSES_INCLUDE_DIR)
   find_package(PkgConfig QUIET)
   # First try for NCurses
-  pkg_search_module (PC_NCurses QUIET ncurses ncursesw)
+  pkg_search_module (PC_NCurses QUIET ncursesw ncurses)
 endif()
 
 find_path(NCURSES_INCLUDE_DIR
@@ -67,10 +67,20 @@ if(NCURSES_NOT_FOUND EQUAL -1)
     if (DEFINED PC_NCurses_LINK_LIBRARIES)
         set(CURSES_LIBRARY ${PC_NCurses_LINK_LIBRARIES})
     else()
-        find_library(CURSES_LIBRARY
-            NAMES ncurses ncursesw
-            PATHS ${PC_NCurses_LIBRARY_DIRS}
-        )
+        if(MINGW)
+            # On MinGW, prefer the shared library import lib (libncursesw.dll.a) over static (libncurses.a)
+            # and prefer wide-char version (ncursesw)
+            set(CMAKE_FIND_LIBRARY_SUFFIXES ".dll.a" ".a")
+            find_library(CURSES_LIBRARY
+                NAMES ncursesw ncurses
+                PATHS ${PC_NCurses_LIBRARY_DIRS}
+            )
+        else()
+            find_library(CURSES_LIBRARY
+                NAMES ncursesw ncurses
+                PATHS ${PC_NCurses_LIBRARY_DIRS}
+            )
+        endif()
     endif()
 
     include(FindPackageHandleStandardArgs)
@@ -134,6 +144,7 @@ else()
             PATHS ${PC_PDCurses_LIBRARY_DIRS}
         )
 
+
         set(CURSES_VERSION ${PC_PDCurses_VERSION})
 
         include(FindPackageHandleStandardArgs)
@@ -153,12 +164,33 @@ else()
         set(CURSES_DEFINITIONS ${PC_PDCurses_CFLAGS_OTHER})
 
         if (NOT TARGET Curses::curses)
-            add_library(Curses::curses UNKNOWN IMPORTED)
-            set_target_properties(Curses::curses PROPERTIES
-                INTERFACE_COMPILE_OPTIONS "${PC_PDCurses_CFLAGS_OTHER}"
-                INTERFACE_INCLUDE_DIRECTORIES "${CURSES_INCLUDE_DIRS}"
-                IMPORTED_LOCATION "${CURSES_LIBRARIES}"
-            )
+            if(MINGW)
+                add_library(Curses::curses SHARED IMPORTED)
+                get_filename_component(_LIB_DIR "${CURSES_LIBRARY}" DIRECTORY)
+                file(GLOB _DLL_GLOB "${_LIB_DIR}/*curses*.dll")
+                if(_DLL_GLOB)
+                    list(GET _DLL_GLOB 0 _DLL_PATH)
+                    set_target_properties(Curses::curses PROPERTIES
+                        INTERFACE_COMPILE_OPTIONS "${PC_PDCurses_CFLAGS_OTHER}"
+                        INTERFACE_INCLUDE_DIRECTORIES "${CURSES_INCLUDE_DIRS}"
+                        IMPORTED_LOCATION "${_DLL_PATH}"
+                        IMPORTED_IMPLIB "${CURSES_LIBRARY}"
+                    )
+                else()
+                    set_target_properties(Curses::curses PROPERTIES
+                        INTERFACE_COMPILE_OPTIONS "${PC_PDCurses_CFLAGS_OTHER}"
+                        INTERFACE_INCLUDE_DIRECTORIES "${CURSES_INCLUDE_DIRS}"
+                        IMPORTED_LOCATION "${CURSES_LIBRARY}"
+                    )
+                endif()
+            else()
+                add_library(Curses::curses UNKNOWN IMPORTED)
+                set_target_properties(Curses::curses PROPERTIES
+                    INTERFACE_COMPILE_OPTIONS "${PC_PDCurses_CFLAGS_OTHER}"
+                    INTERFACE_INCLUDE_DIRECTORIES "${CURSES_INCLUDE_DIRS}"
+                    IMPORTED_LOCATION "${CURSES_LIBRARY}"
+                )
+            endif()
         endif()
     else()
         message(FATAL_ERROR "Unable to find ncurses or pdcurses")
diff --git a/cmake/FindPthreadW32.cmake b/cmake/FindPthreadW32.cmake
index 64ebfc9048..0849ada8a1 100644
--- a/cmake/FindPthreadW32.cmake
+++ b/cmake/FindPthreadW32.cmake
@@ -60,9 +60,9 @@ endif()
 
 if(NOT PThreadW32_LIBRARIES)
   find_library(PThreadW32_LIBRARY_RELEASE
-    NAMES pthreadVC2 pthreadVC3 PATHS ${PC_PThreadW32_LIBRARY_DIRS})
+    NAMES pthreadVC2 pthreadVC3 pthread winpthread PATHS ${PC_PThreadW32_LIBRARY_DIRS})
   find_library(PThreadW32_LIBRARY_DEBUG
-    NAMES pthreadVC2d pthreadVC3d PATHS ${PC_PThreadW32_LIBRARY_DIRS})
+    NAMES pthreadVC2d pthreadVC3d pthread winpthread PATHS ${PC_PThreadW32_LIBRARY_DIRS})
 
   include(SelectLibraryConfigurations)
   SELECT_LIBRARY_CONFIGURATIONS(PThreadW32)
diff --git a/cmake/FindRust.cmake b/cmake/FindRust.cmake
index 79bb657cf6..a7d930def0 100644
--- a/cmake/FindRust.cmake
+++ b/cmake/FindRust.cmake
@@ -282,7 +282,7 @@ function(add_rust_library)
     set(multiValueArgs ENVIRONMENT)
     cmake_parse_arguments(ARGS "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})
 
-    if(WIN32)
+    if(MSVC)
         set(OUTPUT "${ARGS_BINARY_DIRECTORY}/${RUST_COMPILER_TARGET}/${CARGO_BUILD_TYPE}/${ARGS_TARGET}.lib")
     else()
         set(OUTPUT "${ARGS_BINARY_DIRECTORY}/${RUST_COMPILER_TARGET}/${CARGO_BUILD_TYPE}/lib${ARGS_TARGET}.a")
@@ -456,11 +456,23 @@ if(NOT RUST_COMPILER_TARGET)
     # Note: Users may override automatic target detection by specifying their own. Most likely needed for cross-compiling.
     # For reference determining target platform: https://doc.rust-lang.org/nightly/rustc/platform-support.html
     if(WIN32)
-        # For windows x86/x64, it's easy enough to guess the target.
+        # For Windows, detect the appropriate target based on compiler
         if(CMAKE_SIZEOF_VOID_P EQUAL 8)
-            set(RUST_COMPILER_TARGET "x86_64-pc-windows-msvc")
+            if(MSVC)
+                set(RUST_COMPILER_TARGET "x86_64-pc-windows-msvc")
+            elseif(CMAKE_C_COMPILER_ID MATCHES "GNU")
+                set(RUST_COMPILER_TARGET "x86_64-pc-windows-gnu")
+            elseif(CMAKE_C_COMPILER_ID MATCHES "Clang")
+                set(RUST_COMPILER_TARGET "x86_64-pc-windows-gnu")
+            endif()
         else()
-            set(RUST_COMPILER_TARGET "i686-pc-windows-msvc")
+            if(MSVC)
+                set(RUST_COMPILER_TARGET "i686-pc-windows-msvc")
+            elseif(CMAKE_C_COMPILER_ID MATCHES "GNU")
+                set(RUST_COMPILER_TARGET "i686-pc-windows-gnu") 
+            elseif(CMAKE_C_COMPILER_ID MATCHES "Clang")
+                set(RUST_COMPILER_TARGET "i686-pc-windows-gnu")
+            endif()
         endif()
     elseif(CMAKE_SYSTEM_NAME STREQUAL Darwin AND "${CMAKE_OSX_ARCHITECTURES}" MATCHES "^(arm64;x86_64|x86_64;arm64)$")
         # Special case for Darwin because we may want to build universal binaries.
diff --git a/common/scanmem.h b/common/scanmem.h
index bfe7999a6c..8bbca80bfa 100644
--- a/common/scanmem.h
+++ b/common/scanmem.h
@@ -30,8 +30,6 @@
 
 #define TIMEOUT_MODULE 30000
 
-int scanmem(struct mem_info *info);
-
 /* cache helpers */
 typedef struct _filelist_t {
     char filename[MAX_PATH];
@@ -67,4 +65,6 @@ struct mem_info {
     struct cl_scan_options *options;
 };
 
+int scanmem(struct mem_info *info);
+
 #endif
diff --git a/freshclam/CMakeLists.txt b/freshclam/CMakeLists.txt
index 1aad53091e..8d5ec3dc06 100644
--- a/freshclam/CMakeLists.txt
+++ b/freshclam/CMakeLists.txt
@@ -41,7 +41,9 @@ target_link_libraries(freshclam-bin
         ClamAV::common )
 if(WIN32)
     install(TARGETS freshclam-bin DESTINATION . COMPONENT programs)
-    install(FILES $<TARGET_PDB_FILE:freshclam-bin> DESTINATION . OPTIONAL COMPONENT programs)
+    if(MSVC)
+        install(FILES $<TARGET_PDB_FILE:freshclam-bin> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS freshclam-bin DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/freshclam/freshclam.c b/freshclam/freshclam.c
index 09a4bb0dea..d4894e437d 100644
--- a/freshclam/freshclam.c
+++ b/freshclam/freshclam.c
@@ -288,7 +288,7 @@ fc_error_t download_complete_callback(const char *dbFilename, void *context)
 
     if (fc_context->bTestDatabases) {
 #ifdef _WIN32
-
+#ifdef _MSC_VER
         __try {
             ret = fc_test_database(dbFilename, fc_context->bBytecodeEnabled);
         } __except (logg(LOGG_ERROR, "Exception during database testing, code %08x\n",
@@ -301,6 +301,15 @@ fc_error_t download_complete_callback(const char *dbFilename, void *context)
             status = FC_ETESTFAIL;
             goto done;
         }
+#else
+        /* MinGW doesn't support MSVC's __try/__except */
+        ret = fc_test_database(dbFilename, fc_context->bBytecodeEnabled);
+        if (FC_SUCCESS != ret) {
+            logg(LOGG_WARNING, "Database load exited with \"%s\"\n", fc_strerror(ret));
+            status = FC_ETESTFAIL;
+            goto done;
+        }
+#endif
 
 #else
 
diff --git a/libclamav/CMakeLists.txt b/libclamav/CMakeLists.txt
index 16b78a4afb..b01031dd63 100644
--- a/libclamav/CMakeLists.txt
+++ b/libclamav/CMakeLists.txt
@@ -428,7 +428,6 @@ if(ENABLE_SHARED_LIB)
             yara
             bytecode_runtime
             ${LIBMSPACK}
-            ClamAV::libclamav_rust
             ClamAV::libunrar_iface_iface
             OpenSSL::SSL
             OpenSSL::Crypto
@@ -436,7 +435,12 @@ if(ENABLE_SHARED_LIB)
             BZip2::BZip2
             PCRE2::pcre2
             LibXml2::LibXml2
-            JSONC::jsonc )
+            JSONC::jsonc
+        PRIVATE
+            ClamAV::libclamav_rust )
+    if(WIN32 AND CMAKE_C_COMPILER_ID MATCHES "GNU")
+        target_link_libraries( clamav PRIVATE -Wl,--whole-archive $<TARGET_FILE:ClamAV::libclamav_rust> -Wl,--no-whole-archive )
+    endif()
 
     if(WIN32)
         target_link_libraries( clamav
@@ -472,6 +476,12 @@ if(ENABLE_SHARED_LIB)
 
     if(WIN32)
         set_target_properties( clamav PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON )
+        # Allow undefined symbols from Rust library (circular dependency with libclamav)
+        # The Rust library references libclamav functions, but we're linking it into libclamav.dll
+        # These symbols will be resolved at runtime since they're in the same DLL
+        if(CMAKE_C_COMPILER_ID MATCHES "GNU")
+            target_link_options( clamav PRIVATE "-Wl,--warn-unresolved-symbols" )
+        endif()
     else()
         target_link_libraries( clamav PUBLIC Iconv::Iconv )
     endif()
@@ -484,7 +494,9 @@ if(ENABLE_SHARED_LIB)
     endif()
     if(WIN32)
         install( TARGETS clamav DESTINATION . COMPONENT libraries )
-        install( FILES $<TARGET_PDB_FILE:clamav> DESTINATION . OPTIONAL COMPONENT libraries )
+        if(MSVC)
+            install( FILES $<TARGET_PDB_FILE:clamav> DESTINATION . OPTIONAL COMPONENT libraries )
+        endif()
         # Also install shared library (DLL) dependencies
         install( CODE [[
             file(GET_RUNTIME_DEPENDENCIES
diff --git a/libclamav/clamav.h b/libclamav/clamav.h
index b41d39e39b..c715be6c99 100644
--- a/libclamav/clamav.h
+++ b/libclamav/clamav.h
@@ -32,7 +32,7 @@
 #include <openssl/err.h>
 
 /* Certain OSs already use 64bit variables in their stat struct */
-#if (!defined(__FreeBSD__) && !defined(__APPLE__))
+#if (!defined(__FreeBSD__) && !defined(__APPLE__) && !defined(_WIN32))
 #define STAT64_OK 1
 #else
 #define STAT64_OK 0
diff --git a/libclamav/crypto.c b/libclamav/crypto.c
index 8b398e402f..52c22b63f9 100644
--- a/libclamav/crypto.c
+++ b/libclamav/crypto.c
@@ -69,21 +69,73 @@
 #include "iowrap.h"
 
 #if defined(_WIN32)
+#if defined(__GNUC__) && !defined(__x86_64__) && !defined(_M_X64)  /* MinGW 32-bit only */
+#define __try1_hash(filter) \
+    { \
+        struct _EXCEPTION_POINTERS *ep = NULL; \
+        int __exception_code = 0; \
+        __asm__ __volatile__( \
+            ".l_startw_hash%=:\n\t" \
+            "pushl %%ebp\n\t" \
+            "movl %%esp, %%ebp\n\t" \
+            : : : "memory"); \
+        if (!(filter(__exception_code, ep))) { \
+            __asm__ __volatile__(".l_endw_hash%=:\n\t" : : :); \
+            goto error_hash; \
+        } \
+    }
+
+#define __except1_hash \
+    goto end_hash; \
+    error_hash: \
+    { \
+        __asm__ __volatile__( \
+            ".section .text\n\t" \
+            ".l_exception_hash%=:\n\t" \
+            ".long .l_startw_hash%=-.+4\n\t" \
+            ".long .l_endw_hash%=-.+4\n\t" \
+            ".previous\n\t" \
+            : : : "memory"); \
+    } \
+    end_hash:
+
+#define __try1_update(filter) \
+    { \
+        struct _EXCEPTION_POINTERS *ep = NULL; \
+        int __exception_code = 0; \
+        __asm__ __volatile__( \
+            ".l_startw_update%=:\n\t" \
+            "pushl %%ebp\n\t" \
+            "movl %%esp, %%ebp\n\t" \
+            : : : "memory"); \
+        if (!(filter(__exception_code, ep))) { \
+            __asm__ __volatile__(".l_endw_update%=:\n\t" : : :); \
+            goto error_update; \
+        } \
+    }
+
+#define __except1_update \
+    goto end_update; \
+    error_update: \
+    { \
+        __asm__ __volatile__( \
+            ".section .text\n\t" \
+            ".l_exception_update%=:\n\t" \
+            ".long .l_startw_update%=-.+4\n\t" \
+            ".long .l_endw_update%=-.+4\n\t" \
+            ".previous\n\t" \
+            : : : "memory"); \
+    } \
+    end_update:
+#endif
 char *strptime(const char *buf, const char *fmt, struct tm *tm);
 #endif
 
-#if defined(_WIN32)
-#define EXCEPTION_PREAMBLE __try {
-#define EXCEPTION_POSTAMBLE                                                 \
-    }                                                                       \
-    __except (filter_memcpy(GetExceptionCode(), GetExceptionInformation())) \
-    {                                                                       \
-        win_exception = true;                                               \
-    }
-#else
+
+
 #define EXCEPTION_PREAMBLE
 #define EXCEPTION_POSTAMBLE
-#endif
+
 
 #if !defined(MIN)
 #define MIN(x, y) ((x) < (y) ? (x) : (y))
@@ -870,7 +922,38 @@ unsigned char *cl_hash_data(const char *alg, const void *buf, size_t len, unsign
     while (cur < len) {
         size_t todo = MIN((unsigned long)EVP_MD_block_size(md), (unsigned long)(len - cur));
 
-        EXCEPTION_PREAMBLE
+#ifdef _WIN32
+#if defined(__GNUC__) && !defined(__x86_64__) && !defined(_M_X64)  /* MinGW 32-bit only */
+        __try1_hash(filter_memcpy) {
+            if (!EVP_DigestUpdate(ctx, (void *)(((unsigned char *)buf) + cur), todo)) {
+                if (!(obuf))
+                    free(ret);
+
+                if ((olen))
+                    *olen = 0;
+
+                EVP_MD_CTX_destroy(ctx);
+                return NULL;
+            }
+        } __except1_hash {
+            winres = 1;
+        }
+#elif defined(_MSC_VER)  /* MSVC */
+        __try {
+            if (!EVP_DigestUpdate(ctx, (void *)(((unsigned char *)buf) + cur), todo)) {
+                if (!(obuf))
+                    free(ret);
+
+                if ((olen))
+                    *olen = 0;
+
+                EVP_MD_CTX_destroy(ctx);
+                return NULL;
+            }
+        } __except(filter_memcpy(GetExceptionCode(), GetExceptionInformation())) {
+            winres = 1;
+        }
+#else  /* MinGW 64-bit or other */
         if (!EVP_DigestUpdate(ctx, (void *)(((unsigned char *)buf) + cur), todo)) {
             if (!(obuf))
                 free(ret);
@@ -885,7 +968,19 @@ unsigned char *cl_hash_data(const char *alg, const void *buf, size_t len, unsign
             EVP_MD_CTX_destroy(ctx);
             return NULL;
         }
-        EXCEPTION_POSTAMBLE
+#endif
+#else
+        if (!EVP_DigestUpdate(ctx, (void *)(((unsigned char *)buf) + cur), todo)) {
+            if (!(obuf))
+                free(ret);
+
+            if ((olen))
+                *olen = 0;
+
+            EVP_MD_CTX_destroy(ctx);
+            return NULL;
+        }
+#endif
 
 #if defined(_WIN32)
         if (win_exception) {
@@ -1044,14 +1139,41 @@ unsigned char *cl_hash_file_fd_ctx(EVP_MD_CTX *ctx, int fd, unsigned int *olen)
 #else
     while ((nread = read(fd, buf, blocksize)) > 0) {
 #endif
-        EXCEPTION_PREAMBLE
+#ifdef _WIN32
+#if defined(__GNUC__) && !defined(__x86_64__) && !defined(_M_X64)  /* MinGW 32-bit only */
+        __try1(filter_memcpy) {
+            if (!EVP_DigestUpdate(ctx, buf, nread)) {
+                free(buf);
+                free(hash);
+                return NULL;
+            }
+        } __except1 {
+            winres = 1;
+        }
+#elif defined(_MSC_VER)  /* MSVC */
+        __try {
+            if (!EVP_DigestUpdate(ctx, buf, nread)) {
+                free(buf);
+                free(hash);
+                return NULL;
+            }
+        } __except(filter_memcpy(GetExceptionCode(), GetExceptionInformation())) {
+            winres = 1;
+        }
+#else  /* MinGW 64-bit or other */
         if (!EVP_DigestUpdate(ctx, buf, nread)) {
             free(buf);
             free(hash);
-
             return NULL;
         }
-        EXCEPTION_POSTAMBLE
+#endif
+#else
+        if (!EVP_DigestUpdate(ctx, buf, nread)) {
+            free(buf);
+            free(hash);
+            return NULL;
+        }
+#endif
 
 #if defined(_WIN32)
         if (win_exception) {
@@ -1907,10 +2029,29 @@ int cl_update_hash(void *ctx, const void *data, size_t sz)
     if (!(ctx) || !(data))
         return -1;
 
-    EXCEPTION_PREAMBLE
+#ifdef _WIN32
+#if defined(__GNUC__) && !defined(__x86_64__) && !defined(_M_X64)  /* MinGW 32-bit only */
+    __try1_update(filter_memcpy) {
+        if (!EVP_DigestUpdate((EVP_MD_CTX *)ctx, data, sz))
+            return -1;
+    } __except1_update {
+        winres = 1;
+    }
+#elif defined(_MSC_VER)  /* MSVC */
+    __try {
+        if (!EVP_DigestUpdate((EVP_MD_CTX *)ctx, data, sz))
+            return -1;
+    } __except(filter_memcpy(GetExceptionCode(), GetExceptionInformation())) {
+        winres = 1;
+    }
+#else  /* MinGW 64-bit or other */
     if (!EVP_DigestUpdate((EVP_MD_CTX *)ctx, data, sz))
         return -1;
-    EXCEPTION_POSTAMBLE
+#endif
+#else
+    if (!EVP_DigestUpdate((EVP_MD_CTX *)ctx, data, sz))
+        return -1;
+#endif
 
 #if defined(_WIN32)
     if (win_exception) {
diff --git a/libclamav/iowrap.c b/libclamav/iowrap.c
index 8a19ef79e9..a92393fca0 100644
--- a/libclamav/iowrap.c
+++ b/libclamav/iowrap.c
@@ -27,6 +27,9 @@
 #ifdef _WIN32
 #include <windows.h>
 #include <excpt.h>
+#ifdef __GNUC__
+#include <excpt.h>
+#endif
 
 #ifndef STATUS_DEVICE_DATA_ERROR
 #define STATUS_DEVICE_DATA_ERROR 0xC000009C
@@ -48,13 +51,24 @@ cl_error_t cli_memcpy(void *target, const void *source, unsigned long size)
     cl_error_t ret = CL_SUCCESS;
 
 #ifdef _WIN32
+#if defined(__GNUC__) && !defined(__x86_64__) && !defined(_M_X64)  /* MinGW 32-bit only */
+    /* MinGW uses __try1/__except1 for SEH */
+    __try1(filter_memcpy) {
+        memcpy(target, source, size);
+    } __except1 {
+        ret = CL_EACCES;
+    }
+#elif defined(_MSC_VER)  /* MSVC */
     __try {
-#endif
         memcpy(target, source, size);
-#ifdef _WIN32
     } __except (filter_memcpy(GetExceptionCode(), GetExceptionInformation())) {
         ret = CL_EACCES;
     }
+#else  /* MinGW 64-bit or other */
+    memcpy(target, source, size);
+#endif
+#else
+    memcpy(target, source, size);
 #endif
     return ret;
 }
diff --git a/libclamav/libclamav_main.c b/libclamav/libclamav_main.c
index 5c6400d8c2..8549d9447d 100644
--- a/libclamav/libclamav_main.c
+++ b/libclamav/libclamav_main.c
@@ -37,21 +37,38 @@ BOOL APIENTRY DllMain(HMODULE hm, DWORD why, LPVOID rsrv)
         case DLL_PROCESS_ATTACH:
             if (WSAStartup(MAKEWORD(2, 2), &wsa))
                 return FALSE;
+#ifdef _MSC_VER
             return pthread_win32_process_attach_np();
+#else
+            /* MinGW uses winpthreads which handles this automatically */
+            return TRUE;
+#endif
             break;
 
         case DLL_THREAD_ATTACH:
+#ifdef _MSC_VER
             return pthread_win32_thread_attach_np();
+#else
+            return TRUE;
+#endif
             break;
 
         case DLL_THREAD_DETACH:
+#ifdef _MSC_VER
             return pthread_win32_thread_detach_np();
+#else
+            return TRUE;
+#endif
             break;
 
         case DLL_PROCESS_DETACH:
             WSACleanup();
+#ifdef _MSC_VER
             pthread_win32_thread_detach_np();
             return pthread_win32_process_detach_np();
+#else
+            return TRUE;
+#endif
             break;
     }
 }
diff --git a/libclamav/matcher.h b/libclamav/matcher.h
index 310451b46c..7c690dc3dc 100644
--- a/libclamav/matcher.h
+++ b/libclamav/matcher.h
@@ -232,21 +232,21 @@ struct cli_mtarget {
 #define CLI_MTARGETS 15
 static const struct cli_mtarget cli_mtargets[CLI_MTARGETS] = {
     /* All types for target, name, idx, ac_only, pre-filtering?, # of types */
-    {{CL_TYPE_ANY, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "GENERIC", TARGET_GENERIC, 0, 1, 1},
-    {{CL_TYPE_MSEXE, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "PE", TARGET_PE, 0, 1, 1},
-    {{CL_TYPE_MSOLE2, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "OLE2", TARGET_OLE2, 1, 0, 1},
-    {{CL_TYPE_HTML, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "HTML", TARGET_HTML, 1, 0, 1},
-    {{CL_TYPE_MAIL, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "MAIL", TARGET_MAIL, 1, 1, 1},
-    {{CL_TYPE_GRAPHICS, CL_TYPE_GIF, CL_TYPE_PNG, CL_TYPE_JPEG, CL_TYPE_TIFF, 0, 0, 0, 0, 0}, "GRAPHICS", TARGET_GRAPHICS, 1, 0, 5},
-    {{CL_TYPE_ELF, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "ELF", TARGET_ELF, 1, 0, 1},
-    {{CL_TYPE_TEXT_ASCII, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "ASCII", TARGET_ASCII, 1, 1, 1},
-    {{CL_TYPE_ERROR, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "NOT USED", TARGET_NOT_USED, 1, 0, 1},
-    {{CL_TYPE_MACHO, CL_TYPE_MACHO_UNIBIN, 0, 0, 0, 0, 0, 0, 0, 0}, "MACH-O", TARGET_MACHO, 1, 0, 2},
-    {{CL_TYPE_PDF, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "PDF", TARGET_PDF, 1, 0, 1},
-    {{CL_TYPE_SWF, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "FLASH", TARGET_FLASH, 1, 0, 1},
-    {{CL_TYPE_JAVA, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "JAVA", TARGET_JAVA, 1, 0, 1},
-    {{CL_TYPE_INTERNAL, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "INTERNAL", TARGET_INTERNAL, 1, 0, 1},
-    {{CL_TYPE_OTHER, 0, 0, 0, 0, 0, 0, 0, 0, 0}, "OTHER", TARGET_OTHER, 1, 0, 1}};
+    {{CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "GENERIC", TARGET_GENERIC, 0, 1, 1},
+    {{CL_TYPE_MSEXE, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "PE", TARGET_PE, 0, 1, 1},
+    {{CL_TYPE_MSOLE2, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "OLE2", TARGET_OLE2, 1, 0, 1},
+    {{CL_TYPE_HTML, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "HTML", TARGET_HTML, 1, 0, 1},
+    {{CL_TYPE_MAIL, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "MAIL", TARGET_MAIL, 1, 1, 1},
+    {{CL_TYPE_GRAPHICS, CL_TYPE_GIF, CL_TYPE_PNG, CL_TYPE_JPEG, CL_TYPE_TIFF, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "GRAPHICS", TARGET_GRAPHICS, 1, 0, 5},
+    {{CL_TYPE_ELF, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "ELF", TARGET_ELF, 1, 0, 1},
+    {{CL_TYPE_TEXT_ASCII, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "ASCII", TARGET_ASCII, 1, 1, 1},
+    {{CL_TYPE_ERROR, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "NOT USED", TARGET_NOT_USED, 1, 0, 1},
+    {{CL_TYPE_MACHO, CL_TYPE_MACHO_UNIBIN, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "MACH-O", TARGET_MACHO, 1, 0, 2},
+    {{CL_TYPE_PDF, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "PDF", TARGET_PDF, 1, 0, 1},
+    {{CL_TYPE_SWF, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "FLASH", TARGET_FLASH, 1, 0, 1},
+    {{CL_TYPE_JAVA, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "JAVA", TARGET_JAVA, 1, 0, 1},
+    {{CL_TYPE_INTERNAL, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "INTERNAL", TARGET_INTERNAL, 1, 0, 1},
+    {{CL_TYPE_OTHER, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY, CL_TYPE_ANY}, "OTHER", TARGET_OTHER, 1, 0, 1}};
 
 // clang-format off
 
diff --git a/libclammspack/CMakeLists.txt b/libclammspack/CMakeLists.txt
index e09b0cfb56..494fe61418 100644
--- a/libclammspack/CMakeLists.txt
+++ b/libclammspack/CMakeLists.txt
@@ -81,7 +81,9 @@ if(ENABLE_SHARED_LIB)
 
     if(WIN32)
         install(TARGETS clammspack DESTINATION . COMPONENT libraries)
-        install(FILES $<TARGET_PDB_FILE:clammspack> DESTINATION . OPTIONAL COMPONENT libraries)
+        if(MSVC)
+            install(FILES $<TARGET_PDB_FILE:clammspack> DESTINATION . OPTIONAL COMPONENT libraries)
+        endif()
     else()
         install(TARGETS clammspack DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT libraries)
     endif()
diff --git a/libclamunrar/CMakeLists.txt b/libclamunrar/CMakeLists.txt
index 1e097a7db6..119b8eda6d 100644
--- a/libclamunrar/CMakeLists.txt
+++ b/libclamunrar/CMakeLists.txt
@@ -97,6 +97,7 @@ if(ENABLE_SHARED_LIB)
 
     if(WIN32)
         set_target_properties(clamunrar PROPERTIES WINDOWS_EXPORT_ALL_SYMBOLS ON)
+        target_link_libraries(clamunrar PRIVATE PowrProf wbemuuid Shlwapi)
     elseif(UNIX AND NOT APPLE AND NOT AIX)
         target_link_options(clamunrar PRIVATE "-Wl,--version-script=${CMAKE_CURRENT_SOURCE_DIR}/libclamunrar.map")
         if (${CMAKE_SYSTEM_NAME} MATCHES "SunOS")
@@ -107,7 +108,9 @@ if(ENABLE_SHARED_LIB)
 
     if(WIN32)
         install(TARGETS clamunrar DESTINATION . COMPONENT libraries)
-        install(FILES $<TARGET_PDB_FILE:clamunrar> DESTINATION . OPTIONAL COMPONENT libraries)
+        if(MSVC)
+            install(FILES $<TARGET_PDB_FILE:clamunrar> DESTINATION . OPTIONAL COMPONENT libraries)
+        endif()
     else()
         install(TARGETS clamunrar DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT libraries)
     endif()
diff --git a/libclamunrar/os.hpp b/libclamunrar/os.hpp
index 4b21e49d76..19e47106ee 100644
--- a/libclamunrar/os.hpp
+++ b/libclamunrar/os.hpp
@@ -47,15 +47,21 @@
 #define WINVER _WIN32_WINNT_VISTA
 #define _WIN32_WINNT _WIN32_WINNT_VISTA
 #else
+#ifndef WINVER
 #define WINVER _WIN32_WINNT_WINXP
+#endif
+#ifndef _WIN32_WINNT  
 #define _WIN32_WINNT _WIN32_WINNT_WINXP
 #endif
+#endif
 
 #if !defined(ZIPSFX)
 #define RAR_SMP
 #endif
 
+#ifndef WIN32_LEAN_AND_MEAN
 #define WIN32_LEAN_AND_MEAN
+#endif
 
 #include <windows.h>
 #include <prsht.h>
diff --git a/libclamunrar_iface/CMakeLists.txt b/libclamunrar_iface/CMakeLists.txt
index fd6d5ee811..7400c70d31 100644
--- a/libclamunrar_iface/CMakeLists.txt
+++ b/libclamunrar_iface/CMakeLists.txt
@@ -81,7 +81,9 @@ if(ENABLE_UNRAR)
 
         if(WIN32)
             install(TARGETS clamunrar_iface DESTINATION . COMPONENT libraries)
-            install( FILES $<TARGET_PDB_FILE:clamunrar_iface> DESTINATION . OPTIONAL COMPONENT libraries )
+            if(MSVC)
+                install( FILES $<TARGET_PDB_FILE:clamunrar_iface> DESTINATION . OPTIONAL COMPONENT libraries )
+            endif()
         else()
             install(TARGETS clamunrar_iface DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT libraries)
         endif()
diff --git a/libclamunrar_iface/unrar_iface.h b/libclamunrar_iface/unrar_iface.h
index d598bbd530..5b31fe8a06 100644
--- a/libclamunrar_iface/unrar_iface.h
+++ b/libclamunrar_iface/unrar_iface.h
@@ -64,10 +64,18 @@ typedef struct unrar_metadata_tag {
     uint32_t is_dir;
 } unrar_metadata_t;
 
+#ifdef __cplusplus
+extern "C" {
+#endif
+
 cl_unrar_error_t unrar_open(const char *filename, void **hArchive, char **comment, uint32_t *comment_size, uint8_t debug_flag);
 cl_unrar_error_t unrar_peek_file_header(void *hArchive, unrar_metadata_t *file_metadata);
 cl_unrar_error_t unrar_extract_file(void *hArchive, const char *destPath, char *outputBuffer);
 cl_unrar_error_t unrar_skip_file(void *hArchive);
 void unrar_close(void *hArchive);
 
+#ifdef __cplusplus
+}
+#endif
+
 #endif
diff --git a/libfreshclam/CMakeLists.txt b/libfreshclam/CMakeLists.txt
index 8f52e09660..80a224026d 100644
--- a/libfreshclam/CMakeLists.txt
+++ b/libfreshclam/CMakeLists.txt
@@ -75,7 +75,9 @@ if(ENABLE_SHARED_LIB)
         LINK_DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/libfreshclam.map)
     if(WIN32)
         install(TARGETS freshclam DESTINATION . COMPONENT libraries)
+        if(MSVC)
         install(FILES $<TARGET_PDB_FILE:freshclam> DESTINATION . OPTIONAL COMPONENT libraries)
+        endif()
         # Also install shared library (DLL) dependencies
         install(CODE [[
             file(GET_RUNTIME_DEPENDENCIES
diff --git a/libfreshclam/libfreshclam_main.c b/libfreshclam/libfreshclam_main.c
index ced84b630d..237a14ef79 100644
--- a/libfreshclam/libfreshclam_main.c
+++ b/libfreshclam/libfreshclam_main.c
@@ -35,21 +35,38 @@ BOOL APIENTRY DllMain(HMODULE hm, DWORD why, LPVOID rsrv)
         case DLL_PROCESS_ATTACH:
             if (WSAStartup(MAKEWORD(2, 2), &wsa))
                 return FALSE;
+#ifdef _MSC_VER
             return pthread_win32_process_attach_np();
+#else
+            /* MinGW uses winpthreads which handles this automatically */
+            return TRUE;
+#endif
             break;
 
         case DLL_THREAD_ATTACH:
+#ifdef _MSC_VER
             return pthread_win32_thread_attach_np();
+#else
+            return TRUE;
+#endif
             break;
 
         case DLL_THREAD_DETACH:
+#ifdef _MSC_VER
             return pthread_win32_thread_detach_np();
+#else
+            return TRUE;
+#endif
             break;
 
         case DLL_PROCESS_DETACH:
             WSACleanup();
+#ifdef _MSC_VER
             pthread_win32_thread_detach_np();
             return pthread_win32_process_detach_np();
+#else
+            return TRUE;
+#endif
             break;
     }
 }
diff --git a/platform.h.in b/platform.h.in
index fcf836cd40..181507c422 100644
--- a/platform.h.in
+++ b/platform.h.in
@@ -83,6 +83,10 @@ char *strptime(const char *s, const char *format, struct tm *tm);
 #define O_BINARY 0
 #endif
 
+#ifndef O_LARGEFILE
+#define O_LARGEFILE 0
+#endif
+
 #ifndef	FALSE
 #define FALSE (0)
 #endif
diff --git a/sigtool/CMakeLists.txt b/sigtool/CMakeLists.txt
index 496fa2ce71..78aa57648b 100644
--- a/sigtool/CMakeLists.txt
+++ b/sigtool/CMakeLists.txt
@@ -42,7 +42,9 @@ target_link_libraries( sigtool
         ClamAV::common )
 if(WIN32)
     install(TARGETS sigtool DESTINATION . COMPONENT programs)
+    if(MSVC)
     install(FILES $<TARGET_PDB_FILE:sigtool> DESTINATION . OPTIONAL COMPONENT programs)
+    endif()
 else()
     install(TARGETS sigtool DESTINATION ${CMAKE_INSTALL_BINDIR} COMPONENT programs)
 endif()
diff --git a/win32/compat/gettimeofday.c b/win32/compat/gettimeofday.c
index 48119935ae..c17a1aef18 100644
--- a/win32/compat/gettimeofday.c
+++ b/win32/compat/gettimeofday.c
@@ -23,11 +23,8 @@
 #include "clamav-config.h"
 #endif
 
-#include <WinSock2.h>
-#include <Windows.h>
-#include <sys/types.h>
+#ifndef __MINGW32__
 #include <sys/timeb.h>
-
 #include "gettimeofday.h"
 
 int gettimeofday(struct timeval *tv, struct timezone *tz)
@@ -39,3 +36,4 @@ int gettimeofday(struct timeval *tv, struct timezone *tz)
     tv->tv_usec = t.millitm * 1000;
     return 0;
 }
+#endif
diff --git a/win32/compat/gettimeofday.h b/win32/compat/gettimeofday.h
index d58c4331cb..08408b9f43 100644
--- a/win32/compat/gettimeofday.h
+++ b/win32/compat/gettimeofday.h
@@ -22,6 +22,8 @@
 #ifndef __GETLOCALTIME_H
 #define __GETLOCALTIME_H
 
+#ifndef __MINGW32__
 int gettimeofday(struct timeval *tv, struct timezone *tz);
+#endif
 
 #endif /* __GETLOCALTIME_H */
diff --git a/win32/compat/net.h b/win32/compat/net.h
index 787dfb2d2b..5a4a2bf2cf 100644
--- a/win32/compat/net.h
+++ b/win32/compat/net.h
@@ -28,7 +28,7 @@
 #if defined(_MSC_VER)
 #include <BaseTsd.h>
 typedef SSIZE_T ssize_t;
-#else
+#elif !defined(__MINGW32__) && !defined(__MINGW64__)
 typedef int ssize_t;
 #endif
 #define SSIZE_T_DEFINED
