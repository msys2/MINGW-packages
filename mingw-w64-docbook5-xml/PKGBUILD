# Maintainer: J. Peter Mugaas <jpmugaas@suddenlink.net>

_realname=docbook5-xml
pkgbase=mingw-w64-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-${_realname}")
_vers_50x=(5.0 5.0.1)
_vers_51x=(5.1)
_vers_5x=$_vers_50x
_vers_5x+=$_vers_51x
pkgver=${_vers_51x[-1]}
pkgrel=1
pkgdesc="a complete rewrite of the well-known DocBook 4 XML schema (DTD, Relax NG, W3C schema) for Docbook 5.X (mingw-w64)"
arch=('any')
depends=("${MINGW_PACKAGE_PREFIX}-libxml2")
makedepends=('unzip')
optdepends=('perl: for docbook v4 upgrade tools')
url="https://docbook.org/schemas/5x"
license=('MIT')
for _ver in ${_vers_50x[@]}; do
  source+=("https://docbook.org/xml/$_ver/docbook-$_ver.zip")
#  noextract+=("docbook-$_ver.zip")
done
for _ver in ${_vers_51x[@]}; do
  source+=("https://docbook.org/xml/5.1/docbook-v${_ver}-os.zip")
#  noextract+=("docbook-docbook-v${_ver}-os.zip")
done
sha512sums=('a245796881762cf001f0d32b7c87315cba0454750d6b4178e4546357e320e2ab602d84c08a7e44329f406a8d32340605671c351e87c0b9097582ebf6d10fede4'
            'df85ab724d3205086dfbab40419e268d5bf183b028ed8c58d30068bdc82c1e10fc05bf167d5efcdbeb6b6c9c8dbf96ca4f979fcc6da2e2fea99cbf1bd8aaad30'
            'b55f8eda4dcff9d4ebd31876bc33c244ef3884afc167da1425531266963ba64000fbe619ec7c049ae65c0aab864a5a7228caef08b53f546e2686296d97190873')
install=docbook5-xml-${CARCH}.install
_datadir=${MINGW_PREFIX}/share
  
build() {

  # docbook-5.0x

  for v in 5.0 5.0.1; do
    local _catalog=docbook-$v.xml
    pushd "$srcdir/docbook-$v"
      ${MINGW_PREFIX}/bin/xmlcatalog --create --noout ${_catalog}
      # DTD
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "public" \
        "-//OASIS//DTD DocBook XML ${v}//EN" \
        "file://${_datadir}/xml/docbook/schema/dtd/${v}/docbook.dtd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "system" \
        "http://www.oasis-open.org/docbook/xml/${v}/dtd/docbook.dtd" \
        "file://${_datadir}/xml/docbook/schema/dtd/${v}/docbook.dtd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "system" \
        "http://docbook.org/xml/${v}/dtd/docbook.dtd" \
        "file://${_datadir}/xml/docbook/schema/dtd/${v}/docbook.dtd" ${_catalog}
      # RNG
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/rng/docbook.rng" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rng" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/rng/docbook.rng" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rng" ${_catalog}
      # RNG+XInclude
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/rng/docbookxi.rng" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rng" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/rng/docbookxi.rng" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rng" ${_catalog}
      # RNC
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/rnc/docbook.rnc" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rnc" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/rng/docbook.rnc" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rnc" ${_catalog}
      # RNC+XInclude
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/rnc/docbookxi.rnc" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rnc" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/rng/docbookxi.rnc" \
        "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rnc" ${_catalog}
      # XSD
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/xsd/docbook.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/docbook.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/xsd/docbook.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/docbook.xsd" ${_catalog}
      # XSD + XInclude
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/xsd/docbookxi.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/docbookxi.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/xsd/docbookxi.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/docbookxi.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/xsd/xi.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xi.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/xsd/xi.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xi.xsd" ${_catalog}
      # XLink + XML
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/xsd/xlink.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xlink.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/xsd/xlink.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xlink.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/xsd/xml.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xml.xsd" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/xsd/xml.xsd" \
        "file://${_datadir}/xml/docbook/schema/xsd/${v}/xml.xsd" ${_catalog}
      # Schematron
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://www.oasis-open.org/docbook/xml/${v}/sch/docbook.sch" \
        "file://${_datadir}/xml/docbook/schema/sch/${v}/docbook.sch" ${_catalog}
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
        "http://docbook.org/xml/${v}/sch/docbook.sch" \
        "file://${_datadir}/xml/docbook/schema/sch/${v}/docbook.sch" ${_catalog}

      # ---------------------
      # Build XML catalog files for each Schema
      for s in dtd rng sch xsd; do
        _schema_catalog=${s}/catalog.xml
        ${MINGW_PREFIX}/bin/xmlcatalog --noout --create ${_schema_catalog}
        case $s in
          dtd)
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "public" \
              "-//OASIS//DTD DocBook XML ${v}//EN" \
              "docbook.dtd" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "system" \
              "http://www.oasis-open.org/docbook/xml/${v}/dtd/docbook.dtd" \
              "docbook.dtd" ${_schema_catalog}
            ;;
          sch)
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ;;
          rng)
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbookxi.${s}" \
              "docbookxi.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbookxi.${s}" \
              "docbookxi.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbook.rnc" \
              "docbook.rnc" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.rnc" \
              "docbook.rnc" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbookxi.rnc" \
              "docbookxi.rnc" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbookxi.rnc" \
              "docbookxi.rnc" ${_schema_catalog}
            ;;
          xsd)
            # https://docbook.org/xml/5.0/xsd/docbook.xsd
            # https://docbook.org/xml/5.0/xsd/xml.xsd
            # https://docbook.org/xml/5.0/xsd/xlink.xsd
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.${s}" \
              "docbook.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/docbookxi.${s}" \
              "docbookxi.${s}" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbookxi.${s}" \
              "docbookxi.${s}" ${_schema_catalog}
            # XLink + XML:
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/xlink.xsd" \
              "xlink.xsd" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/xlink.xsd" \
              "xlink.xsd" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://docbook.org/xml/${v}/${s}/xml.xsd" \
              "xml.xsd" ${_schema_catalog}
            ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
              "http://www.oasis-open.org/docbook/xml/${v}/${s}/xml.xsd" \
              "xml.xsd" ${_schema_catalog}
            ;;
        esac
      done
    popd
  done
  
  # docbook-5.1x
  for v in ${_vers_51x}; do
    local _catalog=docbook-$v.xml
    ${MINGW_PREFIX}/bin/xmlcatalog --create --noout ${_catalog}
    # RNG
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://www.oasis-open.org/docbook/xml/${v}/rng/docbook.rng" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rng" ${_catalog}
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://docbook.org/xml/${v}/rng/docbook.rng" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rng" ${_catalog}
    # RNG+XInclude
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://www.oasis-open.org/docbook/xml/${v}/rng/docbookxi.rng" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rng" ${_catalog}
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://docbook.org/xml/${v}/rng/docbookxi.rng" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rng" ${_catalog}
    # RNC
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://www.oasis-open.org/docbook/xml/${v}/rnc/docbook.rnc" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rnc" ${_catalog}
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://docbook.org/xml/${v}/rng/docbook.rnc" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbook.rnc" ${_catalog}
    # RNC+XInclude
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://www.oasis-open.org/docbook/xml/${v}/rnc/docbookxi.rnc" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rnc" ${_catalog}
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://docbook.org/xml/${v}/rng/docbookxi.rnc" \
      "file://${_datadir}/xml/docbook/schema/rng/${v}/docbookxi.rnc" ${_catalog}
    # Schematron
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://www.oasis-open.org/docbook/xml/${v}/sch/docbook.sch" \
      "file://${_datadir}/xml/docbook/schema/sch/${v}/docbook.sch" ${_catalog}
    ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
      "http://docbook.org/xml/${v}/sch/docbook.sch" \
      "file://${_datadir}/xml/docbook/schema/sch/${v}/docbook.sch" ${_catalog}

    # ---------------------
    # Build XML catalog files for each Schema
    for s in schemas/rng schemas/sch; do
      _schema_catalog=${s}/catalog.xml
      ${MINGW_PREFIX}/bin/xmlcatalog --noout --create ${_schema_catalog}
      case $s in
        sch)
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://docbook.org/xml/${v}/${s}/docbook.${s}" \
            "docbook.${s}" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.${s}" \
            "docbook.${s}" ${_schema_catalog}
          ;;
        rng)
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://docbook.org/xml/${v}/${s}/docbook.${s}" \
            "docbook.${s}" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.${s}" \
            "docbook.${s}" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://docbook.org/xml/${v}/${s}/docbookxi.${s}" \
            "docbookxi.${s}" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbookxi.${s}" \
            "docbookxi.${s}" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://docbook.org/xml/${v}/${s}/docbook.rnc" \
            "docbook.rnc" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbook.rnc" \
            "docbook.rnc" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://docbook.org/xml/${v}/${s}/docbookxi.rnc" \
            "docbookxi.rnc" ${_schema_catalog}
          ${MINGW_PREFIX}/bin/xmlcatalog --noout --add "uri" \
            "http://www.oasis-open.org/docbook/xml/${v}/${s}/docbookxi.rnc" \
            "docbookxi.rnc" ${_schema_catalog}
          ;;
      esac
    done
  done
}

package() {

  _docbook5dir="${pkgdir}${_datadir}/xml/docbook"
  	
  # docbook-5.0x

  for v in 5.0 5.0.1; do
    pushd "$srcdir/docbook-5.0"
      for type in dtd rng sch xsd; do
        mkdir -p ${_docbook5dir}/schema/${type}/${v}
        install -m644 ${type}/* ${_docbook5dir}/schema/${type}/${v}
      done
    popd
  done

  # docbook-5.1

  for v in 5.1; do
    pushd "$srcdir/schemas"
      for type in rng sch; do
        mkdir -p ${_docbook5dir}/schema/${type}/${v}
        install -m644 ${type}/* ${_docbook5dir}/schema/${type}/${v}
      done
    popd
  done

  mkdir -p "$pkgdir${MINGW_PREFIX}/bin"
  install -m755 tools/db4-entities.pl "$pkgdir${MINGW_PREFIX}/bin"
  mkdir -p "${_docbook5dir}/stylesheet/docbook5"
  install -m644 tools/db4-upgrade.xsl "${_docbook5dir}/stylesheet/docbook5/"

  msg2 "catalog configuration"  
  mkdir -p "$pkgdir${MINGW_PREFIX}/etc/xml"
  for v in 5.0 5.0.1; do
    pwd
    local _catalog=docbook-$v.xml
    pushd "$srcdir/docbook-$v"
      install -m644 ${_catalog} "$pkgdir${MINGW_PREFIX}/etc/xml/${_catalog}"
    popd
  done
  for v in 5.1; do
    local _catalog=docbook-$v.xml
     install -m644 ${_catalog} "$pkgdir${MINGW_PREFIX}/etc/xml/${_catalog}"
  done
}
