From 2da427d08660fb18cd7f8c64b0246c56d4b4e006 Mon Sep 17 00:00:00 2001
From: Cyril Arnould <cyril.arnould@outlook.com>
Date: Wed, 14 Jun 2023 00:09:59 +0200
Subject: [PATCH 13/17] Require HAVE_FCNTL for file descriptor leak checks

This hasn't been a feature in ezwinports either
---
 lib/fdleak.c    | 2 ++
 locate/locate.c | 2 ++
 2 files changed, 4 insertions(+)

diff --git a/lib/fdleak.c b/lib/fdleak.c
index 84629f12..80a41ff2 100644
--- a/lib/fdleak.c
+++ b/lib/fdleak.c
@@ -390,6 +390,7 @@ complain_about_leaky_fds (void)
   int no_leaks = 1;
   const int leaking_fd = find_first_leaked_fd (non_cloexec_fds, num_cloexec_fds);
 
+#if defined HAVE_FCNTL
   if (leaking_fd >= 0)
     {
       no_leaks = 0;
@@ -399,5 +400,6 @@ complain_about_leaky_fds (void)
 	       "way to reproduce this problem."),
 	     leaking_fd);
     }
+#endif
   assert (no_leaks);
 }
diff --git a/locate/locate.c b/locate/locate.c
index ddc718c9..ce70022d 100644
--- a/locate/locate.c
+++ b/locate/locate.c
@@ -1535,6 +1535,7 @@ opendb (const char *name)
                 |O_LARGEFILE
 #endif
                 );
+#if defined HAVE_FCNTL
   if (fd >= 0)
     {
       /* Make sure it won't survive an exec */
@@ -1544,6 +1545,7 @@ opendb (const char *name)
           fd = -1;
         }
     }
+#endif
   return fd;
 }
 
-- 
2.41.0

