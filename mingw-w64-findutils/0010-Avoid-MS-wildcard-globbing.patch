From 0b28a6bb0120607c65c08f2f59647552daf9ddd2 Mon Sep 17 00:00:00 2001
From: Cyril Arnould <cyril.arnould@outlook.com>
Date: Wed, 14 Jun 2023 00:03:16 +0200
Subject: [PATCH 10/17] Avoid MS wildcard globbing

---
 find/ftsfind.c  | 20 ++++++++++++++++++++
 locate/locate.c | 20 ++++++++++++++++++++
 2 files changed, 40 insertions(+)

diff --git a/find/ftsfind.c b/find/ftsfind.c
index 7825c756..caae348e 100644
--- a/find/ftsfind.c
+++ b/find/ftsfind.c
@@ -62,6 +62,26 @@
 
 #undef  STAT_MOUNTPOINTS
 
+#ifdef __MINGW32__
+/* Starting with MSVCRT.DLL v8.x (Vista and later versions) Microsoft
+   changed their implementation of command-line wildcard globbing,
+   such that even wildcards enclosed in quotes are globbed.  To make
+   Find work on all versions of Windows, we must disable command-line
+   globbing, otherwise Find errors out on commands such as
+
+     find . -name "*.c"
+
+   Contrary to the ezwinports variant, it seems like fts is then
+   taking care of the expansion.  */
+
+#include <dirent.h>
+#include <fnmatch.h>
+# ifdef _W64
+   int _dowildcard = 0;
+# else
+   int _CRT_glob = 0;
+# endif
+#endif
 
 /* FTS_TIGHT_CYCLE_CHECK tries to work around Savannah bug #17877
  * (but actually using it doesn't fix the bug).
diff --git a/locate/locate.c b/locate/locate.c
index 5d6f64fe..9fda81bd 100644
--- a/locate/locate.c
+++ b/locate/locate.c
@@ -105,6 +105,26 @@
 #include "printquoted.h"
 #include "splitstring.h"
 
+#ifdef __MINGW32__
+/* Starting with MSVCRT.DLL v8.x (Vista and later versions) Microsoft
+   changed their implementation of command-line wildcard globbing,
+   such that even wildcards enclosed in quotes are globbed.  To make
+   Find work on all versions of Windows, we must disable command-line
+   globbing, otherwise Find errors out on commands such as
+
+     find . -name "*.c"
+
+   Contrary to the ezwinports variant, it seems like fts is then
+   taking care of the expansion.  */
+
+#include <dirent.h>
+#include <fnmatch.h>
+# ifdef _W64
+   int _dowildcard = 0;
+# else
+   int _CRT_glob = 0;
+# endif
+#endif
 
 /* Warn if a database is older than this.  8 days allows for a weekly
    update that takes up to a day to perform.  */
-- 
2.41.0

