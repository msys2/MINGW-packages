diff --git a/girepository/cmph/meson.build b/girepository/cmph/meson.build
index 2a0cef7e4c7b3e23368266758587c508c81b5e2f..157b09e960a54665867b8ba95073928744e87b25 100644
--- a/girepository/cmph/meson.build
+++ b/girepository/cmph/meson.build
@@ -43,6 +43,7 @@ if cc.get_id() != 'msvc'
     '-Wno-cast-align',
     '-Wno-unused-function',
     '-Wno-return-type',
+    '-Wno-sometimes-uninitialized',
   ])
 endif
 
diff --git a/giscanner/ccompiler.py b/giscanner/ccompiler.py
index a6be9ee666f609203b1cf94ed53559de56a132fc..2912fe0e01173bdd5c841f2f6b68d7114730f07b 100644
--- a/giscanner/ccompiler.py
+++ b/giscanner/ccompiler.py
@@ -95,6 +95,41 @@ def customize_compiler(compiler):
         compiler.shared_lib_extension = shlib_suffix
 
 
+def resolve_mingw_lib(implib, libtool=None):
+    """Returns a DLL name given a path to an import lib
+
+    /full/path/to/libgtk-3.dll.a -> libgtk-3-0.dll
+    """
+
+    args = []
+    if libtool:
+        args.extend(libtool)
+        args.append('--mode=execute')
+
+    # Figure out if we have a gcc toolchain or llvm one
+    dlltool = os.environ.get('DLLTOOL', 'dlltool.exe')
+    dlltool_output = subprocess.run(
+        [dlltool], stdout=subprocess.PIPE,
+        stderr=subprocess.STDOUT,
+        universal_newlines=True).stdout
+    is_llvm = 'llvm-dlltool' in dlltool_output
+
+    if not is_llvm:
+        # gcc dlltool provides this via --identify
+        dlltool_args = args + [dlltool, '--identify']
+        output = subprocess.check_output(dlltool_args + [implib], universal_newlines=True)
+        for line in output.splitlines():
+            return line
+    else:
+        # for llvm we need to parse the output of nm
+        # https://github.com/msys2/MINGW-packages/issues/11994#issuecomment-1176691216
+        output = subprocess.check_output(args + ['nm', implib], universal_newlines=True)
+        for line in output.splitlines():
+            if line.endswith(':'):
+                return line[:-1]
+    return None
+
+
 # Flags that retain macros in preprocessed output.
 FLAGS_RETAINING_MACROS = ['-g3', '-ggdb3', '-gstabs3', '-gcoff3', '-gxcoff3', '-gvms3']
 
@@ -208,7 +243,7 @@ class CCompiler(object):
                 args.append('-libpath:' + library_path)
             else:
                 args.append('-L' + library_path)
-                if os.path.isabs(library_path):
+                if os.name != 'nt' and os.path.isabs(library_path):
                     if libtool:
                         args.append('-rpath')
                         args.append(library_path)
@@ -341,10 +376,6 @@ class CCompiler(object):
         # When we are not using Visual C++ nor clang-cl (i.e. we are using GCC)...
         else:
             libtool = utils.get_libtool_command(options)
-            if libtool:
-                args.extend(libtool)
-                args.append('--mode=execute')
-            args.extend([os.environ.get('DLLTOOL', 'dlltool.exe'), '--identify'])
             proc = subprocess.Popen([self.compiler_cmd, '-print-search-dirs'],
                                     stdout=subprocess.PIPE)
             o, e = proc.communicate()
@@ -400,13 +431,10 @@ class CCompiler(object):
                             tmp_fileobj.close()
                             os.unlink(tmp_filename)
                         else:
-                            proc = subprocess.Popen(args + [implib],
-                                                    stdout=subprocess.PIPE)
-                            o, e = proc.communicate()
-                            for line in o.decode('ascii').splitlines():
-                                shlibs.append(line)
+                            shlib = resolve_mingw_lib(implib, libtool)
+                            if shlib is not None:
+                                shlibs.append(shlib)
                                 found = True
-                                break
             if not found:
                 not_resolved.append(lib)
         if len(not_resolved) > 0:
diff --git a/giscanner/meson.build b/giscanner/meson.build
index 3d7dc678a260b6db38afea809fe15e660d84da7e..5cb6036b09c04a2ef96d97621cc70a5ccaa04fbb 100644
--- a/giscanner/meson.build
+++ b/giscanner/meson.build
@@ -83,6 +83,7 @@ if cc.get_id() != 'msvc'
   custom_c_args = cc.get_supported_arguments([
     '-Wno-missing-field-initializers',
     '-Wno-unused-parameter',
+    '-Wno-misleading-indentation',
   ])
 endif
 
