From e7839e6621722e62d2f619a658845f876acf4b2e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?U=C4=9Fur=20Kurnaz?= <bay.ugur.kurnaz@gmail.com>
Date: Sun, 20 Mar 2022 14:26:35 +0100
Subject: [PATCH 13/13] build_msmf_with_mingw

---
 modules/videoio/cmake/detect_msmf.cmake |  6 ++++--
 modules/videoio/src/cap_msmf.cpp        | 25 +++++++++++++++++++++----
 2 files changed, 25 insertions(+), 6 deletions(-)

diff --git a/modules/videoio/cmake/detect_msmf.cmake b/modules/videoio/cmake/detect_msmf.cmake
index aebc226..f431d19 100644
--- a/modules/videoio/cmake/detect_msmf.cmake
+++ b/modules/videoio/cmake/detect_msmf.cmake
@@ -14,9 +14,11 @@ if(HAVE_MSMF)
       set(HAVE_MSMF_DXVA TRUE)
     endif()
   endif()
-  set(defs "HAVE_MSMF")
+  set(defs "HAVE_MSMF" "STRSAFE_NO_DEPRECATE")
+  set(libs "-levr -lmf -lmfplat -lmfplay -lmfreadwrite -lmfuuid -lshlwapi")
   if(HAVE_MSMF_DXVA)
     list(APPEND defs "HAVE_MSMF_DXVA")
+    list(APPEND libs "-ld3d11 -ldxgi -ldxva2")
   endif()
-  ocv_add_external_target(msmf "" "" "${defs}")
+  ocv_add_external_target(msmf "" "${libs}" "${defs}")
 endif()
diff --git a/modules/videoio/src/cap_msmf.cpp b/modules/videoio/src/cap_msmf.cpp
index d782369..fd633c0 100644
--- a/modules/videoio/src/cap_msmf.cpp
+++ b/modules/videoio/src/cap_msmf.cpp
@@ -37,10 +37,12 @@
 #include <string>
 #include <algorithm>
 #include <deque>
+#include <locale>
 #include <stdio.h>
 #include <stdarg.h>
 #include <string.h>
 
+
 #ifdef _MSC_VER
 #pragma warning(disable:4503)
 #pragma comment(lib, "mfplat")
@@ -57,7 +59,7 @@
 typedef HRESULT (WINAPI *FN_MFCreateDXGIDeviceManager)(UINT *resetToken, IMFDXGIDeviceManager **ppDeviceManager);
 static bool pMFCreateDXGIDeviceManager_initialized = false;
 static FN_MFCreateDXGIDeviceManager pMFCreateDXGIDeviceManager = NULL;
-static void init_MFCreateDXGIDeviceManager()
+static void  init_MFCreateDXGIDeviceManager()
 {
     HMODULE h = LoadLibraryExA("mfplat.dll", NULL, LOAD_LIBRARY_SEARCH_SYSTEM32);
     if (h)
@@ -68,7 +70,16 @@ static void init_MFCreateDXGIDeviceManager()
 }
 #endif
 #pragma comment(lib, "Shlwapi.lib")
+#else
+#ifdef HAVE_MSMF_DXVA
+//MFCreateDXGIDeviceManager is already declared in mfapi.h and defined in mfplat.dll
+typedef HRESULT (WINAPI *FN_MFCreateDXGIDeviceManager)(UINT *resetToken, IMFDXGIDeviceManager **ppDeviceManager);
+static bool pMFCreateDXGIDeviceManager_initialized = true;
+static FN_MFCreateDXGIDeviceManager pMFCreateDXGIDeviceManager = &MFCreateDXGIDeviceManager;
+static void  init_MFCreateDXGIDeviceManager() {}
 #endif
+#endif
+
 
 #include <mferror.h>
 #include <comdef.h>
@@ -150,8 +161,14 @@ public:
         return p->QueryInterface(__uuidof(U), reinterpret_cast<void**>((T**)&lp));
     }
 private:
-    _COM_SMARTPTR_TYPEDEF(T, __uuidof(T));
-    TPtr p;
+    class _com_IIID_wrapper {
+    public:
+        typedef T Interface;
+        static T *GetInterfacePtr() throw() { return NULL; }
+        static T& GetInterface() throw() { return *GetInterfacePtr(); }
+        static const IID& GetIID() throw() { return __uuidof(T); }
+    };
+    _COM_SMARTPTR<_com_IIID_wrapper> p;
 };
 
 #define _ComPtr ComPtr
@@ -1016,7 +1033,7 @@ bool CvCapture_MSMF::configureHW(bool enable)
                                 DXGI_ADAPTER_DESC desc;
                                 if (SUCCEEDED(adapter->GetDesc(&desc))) {
                                     std::wstring name(desc.Description);
-                                    std::wstring_convert<std::codecvt_utf8_utf16<wchar_t>> conv;
+                                    std::wstring_convert< std::codecvt_utf8_utf16<wchar_t> > conv;
                                     CV_LOG_INFO(NULL, "MSMF: Using D3D11 video acceleration on GPU device: " << conv.to_bytes(name));
                                 }
                             }
-- 
2.35.1

