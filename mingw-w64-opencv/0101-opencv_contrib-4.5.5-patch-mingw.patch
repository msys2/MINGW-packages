From 69f73e2ab9e8d787b46ff9fa43792650067044e9 Mon Sep 17 00:00:00 2001
From: Ugur Kurnaz <ugur.kurnaz@free.fr>
Date: Sat, 5 Mar 2022 20:15:53 +0100
Subject: [PATCH] opencv_contrib-4.5.5-patch-mingw

---
 modules/rgbd/src/dynafu.cpp                            |  1 +
 .../libmv_light/libmv/correspondence/CMakeLists.txt    |  2 +-
 .../libmv_light/libmv/multiview/robust_estimation.h    |  4 ++--
 modules/sfm/src/libmv_light/libmv/numeric/numeric.h    |  4 ++--
 modules/wechat_qrcode/CMakeLists.txt                   | 10 ++++++++++
 5 files changed, 16 insertions(+), 5 deletions(-)

diff --git a/modules/rgbd/src/dynafu.cpp b/modules/rgbd/src/dynafu.cpp
index 002be7b..45e55ff 100644
--- a/modules/rgbd/src/dynafu.cpp
+++ b/modules/rgbd/src/dynafu.cpp
@@ -24,6 +24,7 @@
 # include <windows.h>
 #endif
 # include <GL/gl.h>
+# include <GL/glext.h>
 #endif
 
 // GL Extention definitions missing from standard Win32 gl.h
diff --git a/modules/sfm/src/libmv_light/libmv/correspondence/CMakeLists.txt b/modules/sfm/src/libmv_light/libmv/correspondence/CMakeLists.txt
index 95dbebe..c571386 100644
--- a/modules/sfm/src/libmv_light/libmv/correspondence/CMakeLists.txt
+++ b/modules/sfm/src/libmv_light/libmv/correspondence/CMakeLists.txt
@@ -12,6 +12,6 @@ TARGET_LINK_LIBRARIES(correspondence LINK_PRIVATE ${GLOG_LIBRARIES} multiview)
 IF(TARGET Eigen3::Eigen)
   TARGET_LINK_LIBRARIES(correspondence LINK_PUBLIC Eigen3::Eigen)
 ENDIF()
-
+TARGET_LINK_LIBRARIES(correspondence LINK_PRIVATE opencv_imgcodecs)
 
 LIBMV_INSTALL_LIB(correspondence)
diff --git a/modules/sfm/src/libmv_light/libmv/multiview/robust_estimation.h b/modules/sfm/src/libmv_light/libmv/multiview/robust_estimation.h
index a677c5d..7b20eef 100644
--- a/modules/sfm/src/libmv_light/libmv/multiview/robust_estimation.h
+++ b/modules/sfm/src/libmv_light/libmv/multiview/robust_estimation.h
@@ -54,10 +54,10 @@ class MLEScorer {
   double threshold_;
 };
 
-static uint IterationsRequired(int min_samples,
+static unsigned int IterationsRequired(int min_samples,
                         double outliers_probability,
                         double inlier_ratio) {
-  return static_cast<uint>(
+  return static_cast<unsigned int>(
       log(outliers_probability) / log(1.0 - pow(inlier_ratio, min_samples)));
 }
 
diff --git a/modules/sfm/src/libmv_light/libmv/numeric/numeric.h b/modules/sfm/src/libmv_light/libmv/numeric/numeric.h
index dde7e81..9e7927e 100644
--- a/modules/sfm/src/libmv_light/libmv/numeric/numeric.h
+++ b/modules/sfm/src/libmv_light/libmv/numeric/numeric.h
@@ -33,7 +33,7 @@
 #include <Eigen/QR>
 #include <Eigen/SVD>
 
-#if !defined(__MINGW64__)
+#if !defined(__MINGW32__)
 #  if defined(_WIN32) || defined(__APPLE__) || \
       defined(__FreeBSD__) || defined(__NetBSD__)
 static void sincos(double x, double *sinx, double *cosx) {
@@ -41,7 +41,7 @@ static void sincos(double x, double *sinx, double *cosx) {
   *cosx = cos(x);
 }
 #  endif
-#endif  // !__MINGW64__
+#endif  // !__MINGW32__
 
 #if (defined(_WIN32)) && !defined(__MINGW32__)
 inline long lround(double d) {
diff --git a/modules/wechat_qrcode/CMakeLists.txt b/modules/wechat_qrcode/CMakeLists.txt
index d38d9cc..d7f49e0 100644
--- a/modules/wechat_qrcode/CMakeLists.txt
+++ b/modules/wechat_qrcode/CMakeLists.txt
@@ -11,6 +11,16 @@ if(CMAKE_VERSION VERSION_GREATER "3.11")
   endif()
 endif()
 
+# iconv support isn't automatic on some systems
+if(CMAKE_VERSION VERSION_GREATER 3.11)
+  find_package(Iconv QUIET)
+  if(Iconv_FOUND)
+    ocv_target_link_libraries(${the_module} Iconv::Iconv)
+  else()
+    ocv_target_compile_definitions(${the_module} PRIVATE "NO_ICONV=1")
+  endif()
+endif()
+
 # need to change
 set(wechat_qrcode_commit_hash "a8b69ccc738421293254aec5ddb38bd523503252")
 set(hash_detect_caffemodel "238e2b2d6f3c18d6c3a30de0c31e23cf")
-- 
2.35.1

