From 4a9b59224fb148c77dcbd3a7c24f560e2ad4b2e4 Mon Sep 17 00:00:00 2001
From: Christoph Reiter <reiter.christoph@gmail.com>
Date: Tue, 6 Jan 2026 12:45:54 +0100
Subject: [PATCH 012/N] build: Add dynload_win support for MinGW
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Co-authored-by: Алексей <alexey.pawlow@gmail.com>
---
 Makefile.pre.in | 6 ++++++
 configure.ac    | 6 ++++++
 2 files changed, 12 insertions(+)

diff --git a/Makefile.pre.in b/Makefile.pre.in
index f1d3451..62465d8 100644
--- a/Makefile.pre.in
+++ b/Makefile.pre.in
@@ -1963,6 +1963,12 @@ Python/dynload_hpux.o: $(srcdir)/Python/dynload_hpux.c Makefile
 		-DSHLIB_EXT='"$(EXT_SUFFIX)"' \
 		-o $@ $(srcdir)/Python/dynload_hpux.c
 
+Python/dynload_win.o: $(srcdir)/Python/dynload_win.c Makefile
+	$(CC) -c $(PY_CORE_CFLAGS) \
+		-DPYD_PLATFORM_TAG='"$(PYD_PLATFORM_TAG)"' \
+		-DPY3_DLLNAME='L"$(DLLLIBRARY)"' \
+		-o $@ $(srcdir)/Python/dynload_win.c
+
 Python/sysmodule.o: $(srcdir)/Python/sysmodule.c Makefile $(srcdir)/Include/pydtrace.h
 	$(CC) -c $(PY_CORE_CFLAGS) \
 		-DABIFLAGS='"$(ABIFLAGS)"' \
diff --git a/configure.ac b/configure.ac
index 991806a..7192791 100644
--- a/configure.ac
+++ b/configure.ac
@@ -5316,6 +5316,12 @@ then
 	fi
 	;;
 	esac
+	case $host in
+	*-*-mingw*)
+    DYNLOADFILE="dynload_win.o"
+    extra_machdep_objs="$extra_machdep_objs PC/dl_nt.o"
+    ;;
+	esac
 fi
 AC_MSG_RESULT([$DYNLOADFILE])
 if test "$DYNLOADFILE" != "dynload_stub.o"
