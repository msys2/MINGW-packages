From 4b3529befd8bb616be72b8e3c0820b5966ff57c1 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Thu, 17 Jun 2021 18:51:10 +0530
Subject: [PATCH 019/N] sysconfig: make _sysconfigdata.py relocatable
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Co-authored-by: Алексей <alexey.pawlow@gmail.com>
Co-authored-by: lovetox <8661218+lovetox@users.noreply.github.com>
---
 Lib/sysconfig/__main__.py | 22 ++++++++++++++++++++++
 1 file changed, 22 insertions(+)

diff --git a/Lib/sysconfig/__main__.py b/Lib/sysconfig/__main__.py
index bc2197c..a9d1c37 100644
--- a/Lib/sysconfig/__main__.py
+++ b/Lib/sysconfig/__main__.py
@@ -2,6 +2,7 @@ import json
 import os
 import sys
 import types
+import textwrap
 from sysconfig import (
     _ALWAYS_STR,
     _PYTHON_BUILD,
@@ -224,11 +225,32 @@ def _generate_posix_vars():
     os.makedirs(pybuilddir, exist_ok=True)
     destfile = os.path.join(pybuilddir, name + '.py')
 
+    replacement = """
+        keys_to_replace = [
+            'BINDIR', 'BINLIBDEST', 'CONFINCLUDEDIR',
+            'CONFINCLUDEPY', 'DESTDIRS', 'DESTLIB', 'DESTSHARED',
+            'INCLDIRSTOMAKE', 'INCLUDEDIR', 'INCLUDEPY',
+            'LIBDEST', 'LIBDIR', 'LIBPC', 'LIBPL', 'MACHDESTLIB',
+            'MANDIR', 'SCRIPTDIR', 'datarootdir', 'exec_prefix',
+            'TZPATH', 'AR', 'EXENAME', 'LLVM_PROF_MERGER',
+            'VENVLAUNCHERDIR',
+        ]
+
+        prefix = build_time_vars['BINDIR'][:-4]
+        build_time_vars['prefix'] = sys.base_prefix
+
+        for key in keys_to_replace:
+            value = build_time_vars[key]
+            build_time_vars[key] = value.replace(prefix, sys.base_prefix)
+    """
+
     with open(destfile, 'w', encoding='utf8') as f:
+        f.write('import sys\n')
         f.write('# system configuration generated and used by'
                 ' the sysconfig module\n')
         f.write('build_time_vars = ')
         _print_config_dict(vars, stream=f)
+        f.write('\n%s' % textwrap.dedent(replacement))
 
     print(f'Written {destfile}')
 
