From dca0cf6b634ce9831f40b651f7c89f99f01436b7 Mon Sep 17 00:00:00 2001
From: Alexey Pavlov <alexpux@gmail.com>
Date: Wed, 3 Sep 2025 12:25:03 +0300
Subject: [PATCH 090/N] build: build/fix the wmi module

---
 Modules/Setup.stdlib.in | 1 +
 PC/_wmimodule.cpp       | 8 ++++++--
 configure.ac            | 2 ++
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/Modules/Setup.stdlib.in b/Modules/Setup.stdlib.in
index cd7c2e9..9c84aa0 100644
--- a/Modules/Setup.stdlib.in
+++ b/Modules/Setup.stdlib.in
@@ -159,6 +159,7 @@
 # Windows specific modules
 
 @MODULE__OVERLAPPED_TRUE@_overlapped overlapped.c
+@MODULE__WMI_TRUE@_wmi ../PC/_wmimodule.cpp
 @MODULE_WINSOUND_TRUE@winsound ../PC/winsound.c
 
 
diff --git a/PC/_wmimodule.cpp b/PC/_wmimodule.cpp
index 9296d33..6cf9856 100644
--- a/PC/_wmimodule.cpp
+++ b/PC/_wmimodule.cpp
@@ -100,10 +100,12 @@ _query_thread(LPVOID param)
         hr = HRESULT_FROM_WIN32(GetLastError());
     }
     if (SUCCEEDED(hr)) {
+        BSTR bstr_wql = SysAllocString(L"ROOT\\CIMV2");
         hr = locator->ConnectServer(
-            bstr_t(L"ROOT\\CIMV2"),
+            bstr_wql,
             NULL, NULL, 0, NULL, 0, 0, &services
         );
+        SysFreeString(bstr_wql);
     }
     if (SUCCEEDED(hr) && !SetEvent(data.connectEvent)) {
         hr = HRESULT_FROM_WIN32(GetLastError());
@@ -116,13 +118,15 @@ _query_thread(LPVOID param)
         );
     }
     if (SUCCEEDED(hr)) {
+        BSTR bstr_wql = SysAllocString(L"WQL");
         hr = services->ExecQuery(
-            bstr_t("WQL"),
+            bstr_wql,
             bstrQuery,
             WBEM_FLAG_FORWARD_ONLY | WBEM_FLAG_RETURN_IMMEDIATELY,
             NULL,
             &enumerator
         );
+        SysFreeString(bstr_wql);
     }
 
     // Okay, after all that, at this stage we should have an enumerator
diff --git a/configure.ac b/configure.ac
index 966bf41..d745364 100644
--- a/configure.ac
+++ b/configure.ac
@@ -8381,6 +8381,8 @@ dnl windows specific modules
 PY_STDLIB_MOD([winreg], [test "$MACHDEP" = "win32"])
 PY_STDLIB_MOD([msvcrt], [test "$MACHDEP" = "win32"])
 PY_STDLIB_MOD([_winapi], [test "$MACHDEP" = "win32"])
+PY_STDLIB_MOD([_wmi], [test "$MACHDEP" = "win32"], [], [],
+  [-lwbemuuid -lpropsys -lole32 -loleaut32 -luuid])
 PY_STDLIB_MOD([winsound], [test "$MACHDEP" = "win32"], [], [],
   [-lwinmm])
 PY_STDLIB_MOD([_overlapped], [test "$MACHDEP" = "win32"], [], [],
