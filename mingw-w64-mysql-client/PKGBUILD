# Maintainer: https://github.com/taozuhong

_realname=mysql-client
pkgbase="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=9.1.0
pkgrel=1
pkgdesc="MySQL client libraries for mingw (mingw-w64)"
arch=('any')
mingw_arch=('mingw64' 'ucrt64' 'clang64' 'clangarm64')
url="https://github.com/mysql/mysql-server"
license=('spdx:LGPL-2.1-or-later')
options=('!strip')
makedepends=("base-devel"
             "git"
             "libfido2-devel"
             "${MINGW_PACKAGE_PREFIX}-boost"
             "${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-pkgconf"
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja")
depends=("libfido2"
         "${MINGW_PACKAGE_PREFIX}-libevent"
         "${MINGW_PACKAGE_PREFIX}-zlib"
         "${MINGW_PACKAGE_PREFIX}-zstd"
         "${MINGW_PACKAGE_PREFIX}-openssl")
source=("https://github.com/mysql/mysql-server/archive/refs/tags/mysql-${pkgver}.tar.gz"
        "0001-Fixed-build-issue-on-MSYS2.patch")
sha256sums=('2bf56cad7ada7a758620e63e70d6445e5c9d93f910e7594959ea436a9b25a1be'
            '7429cb2f1798c9a2396f9842902f65aa19a99d27b37148a6083a3d1682ac5473')
            
prepare() {
  cd ${srcdir}/mysql-server-mysql-${pkgver}
  patch -p1 -i ${srcdir}/0001-Fixed-build-issue-on-MSYS2.patch
}

build() {
  rm -rf "${srcdir}/build-${MINGW_CHOST}"
  mkdir "${srcdir}/build-${MINGW_CHOST}"
  cd "${srcdir}/build-${MINGW_CHOST}"
  
  declare -a _extra_config
  if check_option "debug" "n"; then
    _extra_config+=("-DCMAKE_BUILD_TYPE=Release")
  else
    _extra_config+=("-DCMAKE_BUILD_TYPE=Debug")
  fi
  
  # MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX="
  "${MINGW_PREFIX}"/bin/cmake -G "MinGW Makefiles" \
    -DCMAKE_INSTALL_PREFIX=${pkgdir}${MINGW_PREFIX} \
    -DINSTALL_INCLUDEDIR=include/mysql \
    -DCMAKE_PREFIX_PATH=${MINGW_PREFIX} \
    ${extra_config[@]} \
    -DWITHOUT_SERVER=ON \
    -DCMAKE_CXX_STANDARD=20 \
    -DDEFAULT_CHARSET=utf8mb4 \
    -DDEFAULT_COLLATION=utf8mb4_general_ci \
    -DWITH_AUTHENTICATION_CLIENT_PLUGINS=OFF \
    -DWITH_UNIT_TESTS=OFF \
    ../mysql-server-mysql-${pkgver}

  ${MINGW_PREFIX}/bin/cmake --build .
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
  ${MINGW_PREFIX}/bin/cmake --install .
}
