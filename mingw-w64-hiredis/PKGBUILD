# Maintainer: taozuhong <taozuhong@gmail.com>

_realname=hiredis
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.0.0
pkgrel=1
pkgdesc="Minimalistic C client for Redis"
arch=('any')
url="https://github.com/redis/hiredis"
license=("BSD-3-Clause License")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
            "${MINGW_PACKAGE_PREFIX}-pkg-config"
            "${MINGW_PACKAGE_PREFIX}-openssl")
depends=("${MINGW_PACKAGE_PREFIX}-gcc-libs"
         "${MINGW_PACKAGE_PREFIX}-crt"
         "${MINGW_PACKAGE_PREFIX}-openssl")
source=("https://github.com/redis/hiredis/archive/v${pkgver}.tar.gz"
        "makefile-001.patch")
sha256sums=('2a0b5fe5119ec973a0c1966bfc4bd7ed39dbce1cb6d749064af9121fe971936f'
            '408dead0310c5eb2ca04b1cd66c2f2d3ba717241f20ca0bc0d258c4b1ad5fe0f')
            
prepare() {
  cd ${srcdir}/${_realname}-${pkgver}
  
  patch -p1 -i "${srcdir}"/makefile-001.patch
}

build() {  
  cd ${srcdir}/${_realname}-${pkgver}
  make PREFIX='${MINGW_PREFIX}' BUILD='${MINGW_CHOST}' HOST='${MINGW_CHOST}' TARGET='${MINGW_CHOST}'
  make USE_SSL=1 PREFIX='${MINGW_PREFIX}' BUILD='${MINGW_CHOST}' HOST='${MINGW_CHOST}' TARGET='${MINGW_CHOST}'
}

package() {
  cd ${srcdir}/${_realname}-${pkgver}
    
  # library
  install -Dm644 "libhiredis.lib" "${pkgdir}${MINGW_PREFIX}/lib/libhiredis.lib"
  install -Dm644 "libhiredis_ssl.lib" "${pkgdir}${MINGW_PREFIX}/lib/libhiredis_ssl.lib"
  install -Dm644 "libhiredis.dll" "${pkgdir}${MINGW_PREFIX}/bin/libhiredis.dll"
  install -Dm644 "libhiredis_ssl.dll" "${pkgdir}${MINGW_PREFIX}/bin/libhiredis_ssl.dll"

  # include
  install -Dm644 "hiredis.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/hiredis.h"
  install -Dm644 "hiredis_ssl.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/hiredis_ssl.h"
  install -Dm644 "async.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/async.h"
  install -Dm644 "read.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/read.h"
  install -Dm644 "sds.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/sds.h"
  install -Dm644 "alloc.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/alloc.h"
  install -Dm644 "adapters/ae.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/ae.h"
  install -Dm644 "adapters/glib.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/glib.h"
  install -Dm644 "adapters/ivykis.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/ivykis.h"
  install -Dm644 "adapters/libev.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/libev.h"
  install -Dm644 "adapters/libevent.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/libevent.h"
  install -Dm644 "adapters/libuv.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/libuv.h"
  install -Dm644 "adapters/macosx.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/macosx.h"
  install -Dm644 "adapters/qt.h" "${pkgdir}${MINGW_PREFIX}/include/${_realname}/adapters/qt.h"

  # pkg-config
  install -Dm644 "${_realname}.pc" "${pkgdir}${MINGW_PREFIX}/lib/pkgconfig/${_realname}.pc"
  install -Dm644 "${_realname}_ssl.pc" "${pkgdir}${MINGW_PREFIX}/lib/pkgconfig/${_realname}_ssl.pc"
}
