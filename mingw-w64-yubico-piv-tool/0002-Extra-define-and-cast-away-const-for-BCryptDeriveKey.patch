diff --git a/CMakeLists.txt b/CMakeLists.txt
index f0d6038..17908d4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -59,6 +59,10 @@ add_definitions(-DOPENSSL_API_COMPAT=0x10000000L)
 
 if(WIN32)
     add_definitions(-DWIN32_LEAN_AND_MEAN)
+    if(NOT MSVC)
+        # needed for BCRYPT_HMAC_SHA1_ALG_HANDLE in lib/internal.c
+        add_definitions(-D_WIN32_WINNT=_WIN32_WINNT_WIN10)
+    endif(NOT MSVC)
     set(_WIN32 ${WIN32})
 endif()
 
diff --git a/lib/internal.c b/lib/internal.c
index deb7a8c..d6efce0 100644
--- a/lib/internal.c
+++ b/lib/internal.c
@@ -374,9 +374,7 @@ pkcs5_rc pkcs5_pbkdf2_sha1(const uint8_t* password, const size_t cb_password, co
   ** PFN_BCryptDeriveKeyPBKDF2 pbkdf2 = GetProcAddress(hBCrypt, "BCryptDeriveKeyPBKDF2");
   */
 
-    /* suppress const qualifier warning b/c BCrypt doesn't take const input buffers */
-#pragma warning(suppress: 4090)
-  if (!BCRYPT_SUCCESS(BCryptDeriveKeyPBKDF2(BCRYPT_HMAC_SHA1_ALG_HANDLE, (PUCHAR)password, (ULONG)cb_password, (PUCHAR)salt, (ULONG)cb_salt, iterations, key, (ULONG)cb_key, 0)))
+  if (!BCRYPT_SUCCESS(BCryptDeriveKeyPBKDF2(BCRYPT_HMAC_SHA1_ALG_HANDLE, (PUCHAR)password, (ULONG)cb_password, (PUCHAR)salt, (ULONG)cb_salt, iterations, (PUCHAR)key, (ULONG)cb_key, 0)))
   {
     rc = PKCS5_GENERAL_ERROR;
   }
