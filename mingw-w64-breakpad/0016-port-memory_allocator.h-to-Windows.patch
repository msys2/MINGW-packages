From 706acb6e3ca383031c16c2754d1d9e672b185d43 Mon Sep 17 00:00:00 2001
From: oltolm <oleg.tolmatcev@gmail.com>
Date: Tue, 17 Feb 2026 23:21:27 +0100
Subject: [PATCH] port memory_allocator.h to Windows

---
 src/common/memory_allocator.h | 25 +++++++++++++++++++++++--
 1 file changed, 23 insertions(+), 2 deletions(-)

diff --git a/src/common/memory_allocator.h b/src/common/memory_allocator.h
index c919a681..841126ad 100644
--- a/src/common/memory_allocator.h
+++ b/src/common/memory_allocator.h
@@ -33,7 +33,11 @@
 #include <stddef.h>
 #include <stdint.h>
 #include <stdlib.h>
+#ifndef _WIN32
 #include <sys/mman.h>
+#else
+#include <windows.h>
+#endif
 #include <unistd.h>
 
 #include <memory>
@@ -43,16 +47,24 @@
 #include <sanitizer/msan_interface.h>
 #endif
 
-#ifdef __APPLE__
+#if defined (__APPLE__)
 #define sys_mmap mmap
 #define sys_munmap munmap
 #define MAP_ANONYMOUS MAP_ANON
-#else
+#elif !defined(_WIN32)
 #include "third_party/lss/linux_syscall_support.h"
 #endif
 
 namespace google_breakpad {
 
+#ifdef _WIN32
+DWORD getpagesize() {
+  SYSTEM_INFO sys_info = {};
+  GetSystemInfo(&sys_info);
+  return sys_info.dwPageSize;
+}
+#endif
+
 // This is very simple allocator which fetches pages from the kernel directly.
 // Thus, it can be used even when the heap may be corrupted.
 //
@@ -133,9 +145,14 @@ class PageAllocator {
 
  private:
   uint8_t* GetNPages(size_t num_pages) {
+#ifdef _WIN32
+    void*  a = VirtualAlloc(nullptr, page_size_ * num_pages, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
+    if (a == nullptr)
+#else
     void* a = sys_mmap(nullptr, page_size_ * num_pages, PROT_READ | PROT_WRITE,
                        MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
     if (a == MAP_FAILED)
+#endif
       return nullptr;
 
 #if defined(MEMORY_SANITIZER)
@@ -159,7 +176,11 @@ class PageAllocator {
 
     for (PageHeader* cur = last_; cur; cur = next) {
       next = cur->next;
+#ifdef _WIN32
+      VirtualFree(cur, cur->num_pages * page_size_, MEM_RELEASE);
+#else
       sys_munmap(cur, cur->num_pages * page_size_);
+#endif
     }
   }
 
-- 
2.53.0.windows.1

