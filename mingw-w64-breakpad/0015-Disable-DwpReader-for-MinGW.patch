From feaec2e602c9beeb28d3e8462d58debba2036476 Mon Sep 17 00:00:00 2001
From: Jon Turney <jon.turney@dronecode.org.uk>
Date: Fri, 17 Nov 2017 17:14:32 +0000
Subject: [PATCH] Disable DwpReader for MinGW

elf_reader.cc uses mmap(), which isn't available

Perhaps we could change to using MmapWrapper(), which I've already fixed for
Windows, but this code isn't doing anything for us anyhow

Signed-off-by: Jon Turney <jon.turney@dronecode.org.uk>
---
 Makefile.am                      | 1 -
 src/common/dwarf/dwarf2reader.cc | 6 ++++++
 src/common/dwarf/dwarf2reader.h  | 7 +++++++
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/Makefile.am b/Makefile.am
index 560f29fc..8abf5483 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -911,7 +911,6 @@ src_tools_windows_dump_syms_dwarf_dump_syms_SOURCES = \
 	src/common/dwarf/bytereader.cc \
 	src/common/dwarf/dwarf2diehandler.cc \
 	src/common/dwarf/dwarf2reader.cc \
-	src/common/dwarf/elf_reader.cc \
 	src/common/pecoff/dump_symbols.cc \
 	src/common/pecoff/pecoffutils.cc \
 	src/common/pecoff/pecoff_file_id.cc \
diff --git a/src/common/dwarf/dwarf2reader.cc b/src/common/dwarf/dwarf2reader.cc
index 0152f484..c497b220 100644
--- a/src/common/dwarf/dwarf2reader.cc
+++ b/src/common/dwarf/dwarf2reader.cc
@@ -501,12 +501,14 @@ uint64_t CompilationUnit::Start() {
     return 0;
   }
 
+#ifdef DWPREADER_WANTED
   // If this is a skeleton compilation unit generated with split DWARF,
   // and the client needs the full debug info, we need to find the full
   // compilation unit in a .dwo or .dwp file.
   should_process_split_dwarf_ =
       !is_split_dwarf_ && dwo_name_ != nullptr &&
       handler_->NeedSplitDebugInfo();
+#endif
 
   return ourlength;
 }
@@ -1051,6 +1053,7 @@ inline int GetElfWidth(const ElfReader& elf) {
   return 0;
 }
 
+#ifdef DWPREADER_WANTED
 bool CompilationUnit::ProcessSplitDwarf(std::string& split_file,
                                         SectionMap& sections,
                                         ByteReader& split_byte_reader,
@@ -1138,7 +1141,9 @@ void CompilationUnit::ReadDebugSectionsFromDwo(ElfReader* elf_reader,
              section_size)));
   }
 }
+#endif
 
+#ifdef DWPREADER_WANTED
 DwpReader::DwpReader(const ByteReader& byte_reader, ElfReader* elf_reader)
     : elf_reader_(elf_reader), byte_reader_(byte_reader),
       cu_index_(nullptr), cu_index_size_(0), string_buffer_(nullptr),
@@ -1353,6 +1358,7 @@ uint32_t DwpReader::LookupCUv2(uint64_t dwo_id) {
   }
   return index;
 }
+#endif
 
 LineInfo::LineInfo(const uint8_t* buffer, uint64_t buffer_length,
                    ByteReader* reader, const uint8_t* string_buffer,
diff --git a/src/common/dwarf/dwarf2reader.h b/src/common/dwarf/dwarf2reader.h
index c58c6b83..0e32e30f 100644
--- a/src/common/dwarf/dwarf2reader.h
+++ b/src/common/dwarf/dwarf2reader.h
@@ -852,11 +852,18 @@ class CompilationUnit {
   // True if we have already looked for a .dwp file.
   bool have_checked_for_dwp_;
 
+#ifdef DWPREADER_WANTED
   // ElfReader for the dwo/dwo file.
   std::unique_ptr<ElfReader> split_elf_reader_;
+#endif
+
+  // ByteReader for the DWP file.
+  std::unique_ptr<ByteReader> dwp_byte_reader_;
 
+#ifdef DWPREADER_WANTED
   // DWP reader.
   std::unique_ptr<DwpReader> dwp_reader_;
+#endif
 
   bool should_process_split_dwarf_;
 
-- 
2.53.0.windows.1

