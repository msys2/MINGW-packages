From 6341a954dfb1417d5f6080593ddb9a49f566f92a Mon Sep 17 00:00:00 2001
From: Jon Turney <jon.turney@dronecode.org.uk>
Date: Tue, 11 Feb 2014 23:48:28 +0000
Subject: [PATCH] Fix Windows client unit-tests with gcc

- MinGW doesn't have _CrtSetReportMode

- Trying to call PureVirtual() on a base class object give a linker error

Use more elaborate contortions to write a pure virtual call that gcc doesn't
spot at compile-time, to provoke a run-time failure (copied from
crash_generation_app)

Signed-off-by: Jon Turney <jon.turney@dronecode.org.uk>
---
 .../unittests/exception_handler_death_test.cc | 28 +++++++++++++------
 .../unittests/exception_handler_test.cc       | 28 +++++++++++++------
 2 files changed, 38 insertions(+), 18 deletions(-)

diff --git a/src/client/windows/unittests/exception_handler_death_test.cc b/src/client/windows/unittests/exception_handler_death_test.cc
index 5d456a7d..0ef3604e 100644
--- a/src/client/windows/unittests/exception_handler_death_test.cc
+++ b/src/client/windows/unittests/exception_handler_death_test.cc
@@ -247,29 +247,37 @@ TEST_F(ExceptionHandlerDeathTest, InvalidParameterTest) {
   ExceptionHandler handler(temp_path_, nullptr, nullptr, nullptr,
                            ExceptionHandler::HANDLER_INVALID_PARAMETER);
 
+#ifdef _MSC_VER
   // Disable the message box for assertions
   _CrtSetReportMode(_CRT_ASSERT, 0);
+#endif
 
   // Call with a bad argument. The invalid parameter will be swallowed
   // and a dump will be generated, the process will exit(0).
   ASSERT_EXIT(printf(nullptr), ::testing::ExitedWithCode(0), "");
 }
 
+struct PureVirtualCall;
 
 struct PureVirtualCallBase {
-  PureVirtualCallBase() {
-    // We have to reinterpret so the linker doesn't get confused because the
-    // method isn't defined.
-    reinterpret_cast<PureVirtualCallBase*>(this)->PureFunction();
-  }
-  virtual ~PureVirtualCallBase() {}
-  virtual void PureFunction() const = 0;
+  PureVirtualCallBase(PureVirtualCall* derived) : derived_(derived) {}
+  virtual ~PureVirtualCallBase();
+  virtual void DoSomething() = 0;
+
+ private:
+  PureVirtualCall* derived_;
 };
+
 struct PureVirtualCall : public PureVirtualCallBase {
-  PureVirtualCall() { PureFunction(); }
-  virtual void PureFunction() const {}
+  PureVirtualCall() : PureVirtualCallBase(this) {}
+  virtual void DoSomething() {}
 };
 
+PureVirtualCallBase:: ~PureVirtualCallBase()
+{
+  derived_->DoSomething();
+}
+
 void ExceptionHandlerDeathTest::DoCrashPureVirtualCall() {
   PureVirtualCall instance;
 }
@@ -281,8 +289,10 @@ TEST_F(ExceptionHandlerDeathTest, PureVirtualCallTest) {
   ExceptionHandler handler(temp_path_, nullptr, nullptr, nullptr,
                            ExceptionHandler::HANDLER_PURECALL);
 
+#ifdef _MSC_VER
   // Disable the message box for assertions
   _CrtSetReportMode(_CRT_ASSERT, 0);
+#endif
 
   // Calls a pure virtual function.
   EXPECT_EXIT(DoCrashPureVirtualCall(), ::testing::ExitedWithCode(0), "");
diff --git a/src/client/windows/unittests/exception_handler_test.cc b/src/client/windows/unittests/exception_handler_test.cc
index 9ebc93fd..0cf6b526 100644
--- a/src/client/windows/unittests/exception_handler_test.cc
+++ b/src/client/windows/unittests/exception_handler_test.cc
@@ -184,8 +184,10 @@ void ExceptionHandlerTest::DoCrashInvalidParameter() {
           google_breakpad::ExceptionHandler::HANDLER_INVALID_PARAMETER,
           kFullDumpType, kPipeName, nullptr);
 
+#ifdef _MSC_VER
   // Disable the message box for assertions
   _CrtSetReportMode(_CRT_ASSERT, 0);
+#endif
 
   // Although this is executing in the child process of the death test,
   // if it's not true we'll still get an error rather than the crash
@@ -194,21 +196,27 @@ void ExceptionHandlerTest::DoCrashInvalidParameter() {
   printf(nullptr);
 }
 
+struct PureVirtualCall;
 
 struct PureVirtualCallBase {
-  PureVirtualCallBase() {
-    // We have to reinterpret so the linker doesn't get confused because the
-    // method isn't defined.
-    reinterpret_cast<PureVirtualCallBase*>(this)->PureFunction();
-  }
-  virtual ~PureVirtualCallBase() {}
-  virtual void PureFunction() const = 0;
+  PureVirtualCallBase(PureVirtualCall* derived) : derived_(derived) {}
+  virtual ~PureVirtualCallBase();
+  virtual void DoSomething() = 0;
+
+ private:
+  PureVirtualCall* derived_;
 };
+
 struct PureVirtualCall : public PureVirtualCallBase {
-  PureVirtualCall() { PureFunction(); }
-  virtual void PureFunction() const {}
+  PureVirtualCall() : PureVirtualCallBase(this) {}
+  virtual void DoSomething() {}
 };
 
+PureVirtualCallBase:: ~PureVirtualCallBase()
+{
+  derived_->DoSomething();
+}
+
 void ExceptionHandlerTest::DoCrashPureVirtualCall() {
   google_breakpad::ExceptionHandler* exc =
       new google_breakpad::ExceptionHandler(
@@ -216,8 +224,10 @@ void ExceptionHandlerTest::DoCrashPureVirtualCall() {
           google_breakpad::ExceptionHandler::HANDLER_PURECALL,
           kFullDumpType, kPipeName, nullptr);
 
+#ifdef _MSC_VER
   // Disable the message box for assertions
   _CrtSetReportMode(_CRT_ASSERT, 0);
+#endif
 
   // Although this is executing in the child process of the death test,
   // if it's not true we'll still get an error rather than the crash
-- 
2.53.0.windows.1

