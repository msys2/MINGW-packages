# Contributor: Raed Rizqie <raed.rizqie@gmail.com>

_realname=napi-rs-tar
pkgbase=mingw-w64-nodejs-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-nodejs-${_realname}"
pkgver=0.1.0
pkgrel=1
pkgdesc='lzma-rs binding to Node.js via napi.rs (mingw-w64)'
arch=('any')
mingw_arch=('mingw64' 'ucrt64' 'clang64')
url='https://napi.rs/'
msys2_repository_url='https://github.com/napi-rs/tar'
license=('spdx:MIT')
depends=("${MINGW_PACKAGE_PREFIX}-nodejs"
         "${MINGW_PACKAGE_PREFIX}-nodejs-napi-rs")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-rust")
source=(https://github.com/napi-rs/tar/archive/refs/tags/v0.1.0.tar.gz)
sha256sums=('a6573d816aec246d9dbda89ea0747612346ed3f0444f51b8b40da386b4a5b416')

package() {
  cd ${srcdir}
  npm install -g @napi-rs/tar@0.1.0 \
    --prefix "${pkgdir}${MINGW_PREFIX}"

  local _arch=x64
  if [[ ${CARCH} == aarch64 ]]; then
    _arch=arm64
  fi

  cd ${srcdir}/tar-${pkgver}
  npm install --ignore-scripts
  npm run build --verbose

  install -Dm755 tar.win32-${_arch}-gnu.node ${pkgdir}${MINGW_PREFIX}/lib/node_modules/@napi-rs/tar/node_modules/@napi-rs/tar-win32-${_arch}-msvc/tar.win32-${_arch}-msvc.node
}
