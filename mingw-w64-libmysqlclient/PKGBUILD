# Maintainer: taozuhong <taozuhong@gmail.com>

_realname=libmysqlclient
pkgbase="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=8.0.35
pkgrel=1
pkgdesc="MySQL client libraries for mingw (mingw-w64)"
arch=('any')
mingw_arch=('mingw32' 'mingw64' 'ucrt64' 'clang64' 'clang32')
url="https://github.com/mysql/mysql-server"
license=("LGPLv2.1")
makedepends=("${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja"
             "${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-tools-git")
depends=("${MINGW_PACKAGE_PREFIX}-libevent"
         "${MINGW_PACKAGE_PREFIX}-openssl"
         "${MINGW_PACKAGE_PREFIX}-zstd")
source=("https://github.com/mysql/mysql-server/archive/refs/tags/mysql-${pkgver}.tar.gz")
sha256sums=('3cfad1c135567362bcb21c44129b4e339cdf0795e7eb7f5a7ac5fd7f0941cbdf')
            
prepare() {
  cd ${srcdir}/mysql-server-mysql-${pkgver}
}

build() {
  rm -rf "${srcdir}/build-${MINGW_CHOST}"
  mkdir "${srcdir}/build-${MINGW_CHOST}"
  cd "${srcdir}/build-${MINGW_CHOST}"
  
  cmake -DWITHOUT_SERVER=ON \
    -DDOWNLOAD_BOOST=1 \
    -DWITH_BOOST=../mysql-server-mysql-${pkgver}/downloads/ \
    -DWITH_UNIT_TESTS=OFF ../mysql-server-mysql-${pkgver}
  ninja -j 8
}

package() {
  cd "${srcdir}/build-${MINGW_CHOST}"
    
  # pkg-config
  install -Dm644 "${srcdir}/${_realname}.pc" "${pkgdir}${MINGW_PREFIX}/lib/pkgconfig/mysqlclient.pc"

  # library
  install -Dm644 "${srcdir}/${_realname}/bin/mysql_config.exe" "${pkgdir}${MINGW_PREFIX}/bin/mysql_config.exe"
  install -Dm644 "${srcdir}/${_realname}/bin/libmysqlclient.a" "${pkgdir}${MINGW_PREFIX}/lib/libmysqlclient.a"
  install -Dm644 "${srcdir}/${_realname}/bin/libmysqlclient.dll" "${pkgdir}${MINGW_PREFIX}/bin/libmysqlclient.dll"

  # include
  mkdir -p ${pkgdir}${MINGW_PREFIX}/include/mysql  
  install -Dm644 ${srcdir}/${_realname}/include/mysql/client_plugin.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysql/plugin_auth_common.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/errmsg.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/field_types.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/my_command. ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/my_compress.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/my_list.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysql.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysql_com.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysql_time.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysql_version.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysqld_error.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysqlx_ername.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysqlx_error.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/mysqlx_version.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  install -Dm644 ${srcdir}/${_realname}/include/udf_registration_types.h ${pkgdir}${MINGW_PREFIX}/include/mysql
  
  install -Dm644 ${srcdir}/${_realname}/share/aclocal/mysql.m4 ${pkgdir}${MINGW_PREFIX}/share/aclocal/mysql.m4

  # License
  install -Dm644 "${srcdir}/${_realname}/copyright" "${pkgdir}${MINGW_PREFIX}/share/${_realname}/License.txt"
  install -Dm644 "${srcdir}/${_realname}/README" "${pkgdir}${MINGW_PREFIX}/share/${_realname}/README"
}
