diff -urN gdal-3.4.0-orig/apps/gdal_grid_lib.cpp gdal-3.4.0/apps/gdal_grid_lib.cpp
--- gdal-3.4.0-orig/apps/gdal_grid_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdal_grid_lib.cpp	2021-11-11 23:32:41 +0800
@@ -719,7 +719,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALGrid( const char *pszDest, GDALDatasetH hSrcDataset,
+GDALDatasetH CPL_DLL GDALGrid( const char *pszDest, GDALDatasetH hSrcDataset,
                        const GDALGridOptions *psOptionsIn, int *pbUsageError )
 
 {
@@ -1026,7 +1026,7 @@
  * @since GDAL 2.1
  */
 
-GDALGridOptions *GDALGridOptionsNew(char** papszArgv, GDALGridOptionsForBinary* psOptionsForBinary)
+GDALGridOptions CPL_DLL *GDALGridOptionsNew(char** papszArgv, GDALGridOptionsForBinary* psOptionsForBinary)
 {
     GDALGridOptions *psOptions =
         static_cast<GDALGridOptions *>(CPLCalloc(1, sizeof(GDALGridOptions)));
@@ -1413,7 +1413,7 @@
  * @since GDAL 2.1
  */
 
-void GDALGridOptionsFree(GDALGridOptions *psOptions)
+void CPL_DLL GDALGridOptionsFree(GDALGridOptions *psOptions)
 {
     if( psOptions == nullptr )
         return;
@@ -1449,7 +1449,7 @@
  * @since GDAL 2.1
  */
 
-void GDALGridOptionsSetProgress( GDALGridOptions *psOptions,
+void CPL_DLL GDALGridOptionsSetProgress( GDALGridOptions *psOptions,
                                  GDALProgressFunc pfnProgress,
                                  void *pProgressData )
 {
diff -urN gdal-3.4.0-orig/apps/gdal_rasterize_lib.cpp gdal-3.4.0/apps/gdal_rasterize_lib.cpp
--- gdal-3.4.0-orig/apps/gdal_rasterize_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdal_rasterize_lib.cpp	2021-11-11 23:34:27 +0800
@@ -617,7 +617,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALRasterize( const char *pszDest, GDALDatasetH hDstDS,
+GDALDatasetH CPL_DLL GDALRasterize( const char *pszDest, GDALDatasetH hDstDS,
                             GDALDatasetH hSrcDataset,
                             const GDALRasterizeOptions *psOptionsIn, int *pbUsageError )
 {
@@ -862,7 +862,7 @@
  * @since GDAL 2.1
  */
 
-GDALRasterizeOptions *GDALRasterizeOptionsNew(char** papszArgv,
+GDALRasterizeOptions CPL_DLL *GDALRasterizeOptionsNew(char** papszArgv,
                                                       GDALRasterizeOptionsForBinary* psOptionsForBinary)
 {
     GDALRasterizeOptions *psOptions = new GDALRasterizeOptions;
@@ -1262,7 +1262,7 @@
  * @since GDAL 2.1
  */
 
-void GDALRasterizeOptionsFree(GDALRasterizeOptions *psOptions)
+void CPL_DLL GDALRasterizeOptionsFree(GDALRasterizeOptions *psOptions)
 {
     if( psOptions == nullptr )
         return;
@@ -1295,7 +1295,7 @@
  * @since GDAL 2.1
  */
 
-void GDALRasterizeOptionsSetProgress( GDALRasterizeOptions *psOptions,
+void CPL_DLL GDALRasterizeOptionsSetProgress( GDALRasterizeOptions *psOptions,
                                       GDALProgressFunc pfnProgress,
                                       void *pProgressData )
 {
diff -urN gdal-3.4.0-orig/apps/gdal_translate_lib.cpp gdal-3.4.0/apps/gdal_translate_lib.cpp
--- gdal-3.4.0-orig/apps/gdal_translate_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdal_translate_lib.cpp	2021-11-11 23:16:39 +0800
@@ -676,7 +676,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALTranslate( const char *pszDest, GDALDatasetH hSrcDataset,
+GDALDatasetH CPL_DLL GDALTranslate( const char *pszDest, GDALDatasetH hSrcDataset,
                             const GDALTranslateOptions *psOptionsIn, int *pbUsageError )
 
 {
@@ -2330,7 +2330,7 @@
  * @since GDAL 2.1
  */
 
-GDALTranslateOptions *GDALTranslateOptionsNew(char** papszArgv, GDALTranslateOptionsForBinary* psOptionsForBinary)
+GDALTranslateOptions CPL_DLL *GDALTranslateOptionsNew(char** papszArgv, GDALTranslateOptionsForBinary* psOptionsForBinary)
 {
     GDALTranslateOptions *psOptions = static_cast<GDALTranslateOptions *>(
         CPLCalloc( 1, sizeof(GDALTranslateOptions)));
@@ -2983,7 +2983,7 @@
  * @since GDAL 2.1
  */
 
-void GDALTranslateOptionsFree(GDALTranslateOptions *psOptions)
+void CPL_DLL GDALTranslateOptionsFree(GDALTranslateOptions *psOptions)
 {
     if( psOptions == nullptr ) return;
 
@@ -3018,7 +3018,7 @@
  * @since GDAL 2.1
  */
 
-void GDALTranslateOptionsSetProgress( GDALTranslateOptions *psOptions,
+void CPL_DLL GDALTranslateOptionsSetProgress( GDALTranslateOptions *psOptions,
                                       GDALProgressFunc pfnProgress, void *pProgressData )
 {
     psOptions->pfnProgress = pfnProgress;
diff -urN gdal-3.4.0-orig/apps/gdalbuildvrt_lib.cpp gdal-3.4.0/apps/gdalbuildvrt_lib.cpp
--- gdal-3.4.0-orig/apps/gdalbuildvrt_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdalbuildvrt_lib.cpp	2021-11-11 23:36:35 +0800
@@ -1681,7 +1681,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALBuildVRT( const char *pszDest,
+GDALDatasetH CPL_DLL GDALBuildVRT( const char *pszDest,
                            int nSrcCount, GDALDatasetH *pahSrcDS, const char* const* papszSrcDSNames,
                            const GDALBuildVRTOptions *psOptionsIn, int *pbUsageError )
 {
@@ -1823,7 +1823,7 @@
  * @since GDAL 2.1
  */
 
-GDALBuildVRTOptions *GDALBuildVRTOptionsNew(char** papszArgv,
+GDALBuildVRTOptions CPL_DLL *GDALBuildVRTOptionsNew(char** papszArgv,
                                             GDALBuildVRTOptionsForBinary* psOptionsForBinary)
 {
     GDALBuildVRTOptions *psOptions = static_cast<GDALBuildVRTOptions *>(
@@ -2058,7 +2058,7 @@
  * @since GDAL 2.1
  */
 
-void GDALBuildVRTOptionsFree( GDALBuildVRTOptions *psOptions )
+void CPL_DLL GDALBuildVRTOptionsFree( GDALBuildVRTOptions *psOptions )
 {
     if( psOptions )
     {
@@ -2088,7 +2088,7 @@
  * @since GDAL 2.1
  */
 
-void GDALBuildVRTOptionsSetProgress( GDALBuildVRTOptions *psOptions,
+void CPL_DLL GDALBuildVRTOptionsSetProgress( GDALBuildVRTOptions *psOptions,
                                       GDALProgressFunc pfnProgress, void *pProgressData )
 {
     psOptions->pfnProgress = pfnProgress ? pfnProgress : GDALDummyProgress;
diff -urN gdal-3.4.0-orig/apps/gdaldem_lib.cpp gdal-3.4.0/apps/gdaldem_lib.cpp
--- gdal-3.4.0-orig/apps/gdaldem_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdaldem_lib.cpp	2021-11-11 23:26:34 +0800
@@ -3378,7 +3378,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALDEMProcessing( const char *pszDest,
+GDALDatasetH CPL_DLL GDALDEMProcessing( const char *pszDest,
                                 GDALDatasetH hSrcDataset,
                                 const char* pszProcessing,
                                 const char* pszColorFilename,
@@ -3944,7 +3944,7 @@
  * @since GDAL 2.1
  */
 
-GDALDEMProcessingOptions *GDALDEMProcessingOptionsNew(
+GDALDEMProcessingOptions CPL_DLL *GDALDEMProcessingOptionsNew(
     char** papszArgv,
     GDALDEMProcessingOptionsForBinary* psOptionsForBinary )
 {
@@ -4212,7 +4212,7 @@
  * @since GDAL 2.1
  */
 
-void GDALDEMProcessingOptionsFree( GDALDEMProcessingOptions *psOptions )
+void CPL_DLL GDALDEMProcessingOptionsFree( GDALDEMProcessingOptions *psOptions )
 {
     if( psOptions )
     {
@@ -4237,7 +4237,7 @@
  * @since GDAL 2.1
  */
 
-void GDALDEMProcessingOptionsSetProgress( GDALDEMProcessingOptions *psOptions,
+void CPL_DLL GDALDEMProcessingOptionsSetProgress( GDALDEMProcessingOptions *psOptions,
                                           GDALProgressFunc pfnProgress,
                                           void *pProgressData )
 {
diff -urN gdal-3.4.0-orig/apps/gdalinfo_lib.cpp gdal-3.4.0/apps/gdalinfo_lib.cpp
--- gdal-3.4.0-orig/apps/gdalinfo_lib.cpp	2021-11-04 19:58:56 +0800
+++ gdal-3.4.0/apps/gdalinfo_lib.cpp	2021-11-11 23:12:15 +0800
@@ -222,7 +222,7 @@
  * @since GDAL 2.1
  */
 
-char *GDALInfo( GDALDatasetH hDataset, const GDALInfoOptions *psOptions )
+char CPL_DLL *GDALInfo( GDALDatasetH hDataset, const GDALInfoOptions *psOptions )
 {
     if( hDataset == nullptr )
         return nullptr;
@@ -1826,7 +1826,7 @@
  * @since GDAL 2.1
  */
 
-GDALInfoOptions *GDALInfoOptionsNew(
+GDALInfoOptions CPL_DLL *GDALInfoOptionsNew(
     char** papszArgv,
     GDALInfoOptionsForBinary* psOptionsForBinary )
 {
@@ -1972,7 +1972,7 @@
  * @since GDAL 2.1
  */
 
-void GDALInfoOptionsFree( GDALInfoOptions *psOptions )
+void CPL_DLL GDALInfoOptionsFree( GDALInfoOptions *psOptions )
 {
     if( psOptions != nullptr )
     {
diff -urN gdal-3.4.0-orig/apps/gdalmdiminfo_lib.cpp gdal-3.4.0/apps/gdalmdiminfo_lib.cpp
--- gdal-3.4.0-orig/apps/gdalmdiminfo_lib.cpp	2021-11-04 19:58:54 +0800
+++ gdal-3.4.0/apps/gdalmdiminfo_lib.cpp	2021-11-11 23:38:06 +0800
@@ -1044,7 +1044,7 @@
  * @since GDAL 3.1
  */
 
-char *GDALMultiDimInfo( GDALDatasetH hDataset,
+char CPL_DLL *GDALMultiDimInfo( GDALDatasetH hDataset,
                         const GDALMultiDimInfoOptions *psOptionsIn )
 {
     if( hDataset == nullptr )
@@ -1135,7 +1135,7 @@
  * @since GDAL 3.1
  */
 
-GDALMultiDimInfoOptions *GDALMultiDimInfoOptionsNew(
+GDALMultiDimInfoOptions CPL_DLL *GDALMultiDimInfoOptionsNew(
     char** papszArgv,
     GDALMultiDimInfoOptionsForBinary* psOptionsForBinary )
 {
@@ -1219,7 +1219,7 @@
  * @since GDAL 3.1
  */
 
-void GDALMultiDimInfoOptionsFree( GDALMultiDimInfoOptions *psOptions )
+void CPL_DLL GDALMultiDimInfoOptionsFree( GDALMultiDimInfoOptions *psOptions )
 {
     delete psOptions;
 }
diff -urN gdal-3.4.0-orig/apps/gdalmdimtranslate_lib.cpp gdal-3.4.0/apps/gdalmdimtranslate_lib.cpp
--- gdal-3.4.0-orig/apps/gdalmdimtranslate_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdalmdimtranslate_lib.cpp	2021-11-11 23:39:32 +0800
@@ -1635,7 +1635,7 @@
  * @since GDAL 3.1
  */
 
-GDALDatasetH GDALMultiDimTranslate( const char* pszDest,
+GDALDatasetH CPL_DLL GDALMultiDimTranslate( const char* pszDest,
                                     GDALDatasetH hDstDS,
                                     int nSrcCount, GDALDatasetH *pahSrcDS,
                                     const GDALMultiDimTranslateOptions *psOptions,
@@ -1801,7 +1801,7 @@
  * @since GDAL 3.1
  */
 
-GDALMultiDimTranslateOptions *GDALMultiDimTranslateOptionsNew(
+GDALMultiDimTranslateOptions CPL_DLL *GDALMultiDimTranslateOptionsNew(
     char** papszArgv, GDALMultiDimTranslateOptionsForBinary* psOptionsForBinary)
 {
     GDALMultiDimTranslateOptions* psOptions = new GDALMultiDimTranslateOptions;
@@ -1924,7 +1924,7 @@
  * @since GDAL 3.1
  */
 
-void GDALMultiDimTranslateOptionsFree( GDALMultiDimTranslateOptions *psOptions )
+void CPL_DLL GDALMultiDimTranslateOptionsFree( GDALMultiDimTranslateOptions *psOptions )
 {
     delete psOptions;
 }
@@ -1943,7 +1943,7 @@
  * @since GDAL 3.1
  */
 
-void GDALMultiDimTranslateOptionsSetProgress( GDALMultiDimTranslateOptions *psOptions,
+void CPL_DLL GDALMultiDimTranslateOptionsSetProgress( GDALMultiDimTranslateOptions *psOptions,
                                               GDALProgressFunc pfnProgress,
                                               void *pProgressData )
 {
diff -urN gdal-3.4.0-orig/apps/gdalwarp_lib.cpp gdal-3.4.0/apps/gdalwarp_lib.cpp
--- gdal-3.4.0-orig/apps/gdalwarp_lib.cpp	2021-11-04 19:58:55 +0800
+++ gdal-3.4.0/apps/gdalwarp_lib.cpp	2021-11-11 23:21:34 +0800
@@ -1226,7 +1226,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALWarp( const char *pszDest, GDALDatasetH hDstDS,
+GDALDatasetH CPL_DLL GDALWarp( const char *pszDest, GDALDatasetH hDstDS,
                        int nSrcCount,
                        GDALDatasetH *pahSrcDS,
                        const GDALWarpAppOptions *psOptionsIn,
@@ -4251,7 +4251,7 @@
  * @since GDAL 2.1
  */
 
-GDALWarpAppOptions *GDALWarpAppOptionsNew(char** papszArgv,
+GDALWarpAppOptions CPL_DLL *GDALWarpAppOptionsNew(char** papszArgv,
                                           GDALWarpAppOptionsForBinary* psOptionsForBinary)
 {
     GDALWarpAppOptions *psOptions = static_cast<GDALWarpAppOptions *>(
@@ -4785,7 +4785,7 @@
  * @since GDAL 2.1
  */
 
-void GDALWarpAppOptionsFree( GDALWarpAppOptions *psOptions )
+void CPL_DLL GDALWarpAppOptionsFree( GDALWarpAppOptions *psOptions )
 {
     if( psOptions )
     {
@@ -4820,7 +4820,7 @@
  * @since GDAL 2.1
  */
 
-void GDALWarpAppOptionsSetProgress( GDALWarpAppOptions *psOptions,
+void CPL_DLL GDALWarpAppOptionsSetProgress( GDALWarpAppOptions *psOptions,
                                       GDALProgressFunc pfnProgress, void *pProgressData )
 {
     psOptions->pfnProgress = pfnProgress ? pfnProgress : GDALDummyProgress;
@@ -4842,7 +4842,7 @@
  * @since GDAL 2.3
  */
 
-void GDALWarpAppOptionsSetQuiet( GDALWarpAppOptions *psOptions,
+void CPL_DLL GDALWarpAppOptionsSetQuiet( GDALWarpAppOptions *psOptions,
                                  int bQuiet )
 {
     psOptions->bQuiet = CPL_TO_BOOL(bQuiet);
@@ -4862,7 +4862,7 @@
  * @since GDAL 2.1
  */
 
-void GDALWarpAppOptionsSetWarpOption( GDALWarpAppOptions *psOptions,
+void CPL_DLL GDALWarpAppOptionsSetWarpOption( GDALWarpAppOptions *psOptions,
                                       const char* pszKey,
                                       const char* pszValue )
 {
diff -urN gdal-3.4.0-orig/apps/nearblack_lib.cpp gdal-3.4.0/apps/nearblack_lib.cpp
--- gdal-3.4.0-orig/apps/nearblack_lib.cpp	2021-11-04 19:58:54 +0800
+++ gdal-3.4.0/apps/nearblack_lib.cpp	2021-11-11 23:28:55 +0800
@@ -761,7 +761,7 @@
  * @since GDAL 2.1
  */
 
-GDALNearblackOptions *GDALNearblackOptionsNew(
+GDALNearblackOptions CPL_DLL *GDALNearblackOptionsNew(
     char** papszArgv,
     GDALNearblackOptionsForBinary* psOptionsForBinary )
 {
@@ -916,7 +916,7 @@
  * @since GDAL 2.1
  */
 
-void GDALNearblackOptionsFree( GDALNearblackOptions *psOptions )
+void CPL_DLL GDALNearblackOptionsFree( GDALNearblackOptions *psOptions )
 {
     if( psOptions == nullptr ) return;
 
@@ -940,7 +940,7 @@
  * @since GDAL 2.1
  */
 
-void GDALNearblackOptionsSetProgress( GDALNearblackOptions *psOptions,
+void CPL_DLL GDALNearblackOptionsSetProgress( GDALNearblackOptions *psOptions,
                                       GDALProgressFunc pfnProgress,
                                       void *pProgressData )
 {
diff -urN gdal-3.4.0-orig/apps/ogr2ogr_lib.cpp gdal-3.4.0/apps/ogr2ogr_lib.cpp
--- gdal-3.4.0-orig/apps/ogr2ogr_lib.cpp	2021-11-04 19:58:56 +0800
+++ gdal-3.4.0/apps/ogr2ogr_lib.cpp	2021-11-11 23:23:55 +0800
@@ -2017,7 +2017,7 @@
  * @since GDAL 2.1
  */
 
-GDALDatasetH GDALVectorTranslate( const char *pszDest, GDALDatasetH hDstDS, int nSrcCount,
+GDALDatasetH CPL_DLL GDALVectorTranslate( const char *pszDest, GDALDatasetH hDstDS, int nSrcCount,
                                   GDALDatasetH *pahSrcDS,
                                   const GDALVectorTranslateOptions *psOptionsIn, int *pbUsageError )
 
@@ -5185,7 +5185,7 @@
  *
  * @since GDAL 2.1
  */
-GDALVectorTranslateOptions *GDALVectorTranslateOptionsNew(char** papszArgv,
+GDALVectorTranslateOptions CPL_DLL *GDALVectorTranslateOptionsNew(char** papszArgv,
                                                       GDALVectorTranslateOptionsForBinary* psOptionsForBinary)
 {
     GDALVectorTranslateOptions *psOptions =
@@ -5951,7 +5951,7 @@
  * @since GDAL 2.1
  */
 
-void GDALVectorTranslateOptionsFree( GDALVectorTranslateOptions *psOptions )
+void CPL_DLL GDALVectorTranslateOptionsFree( GDALVectorTranslateOptions *psOptions )
 {
     if( psOptions == nullptr )
         return;
@@ -6015,7 +6015,7 @@
  * @since GDAL 2.1
  */
 
-void GDALVectorTranslateOptionsSetProgress( GDALVectorTranslateOptions *psOptions,
+void CPL_DLL GDALVectorTranslateOptionsSetProgress( GDALVectorTranslateOptions *psOptions,
                                       GDALProgressFunc pfnProgress, void *pProgressData )
 {
     psOptions->pfnProgress = pfnProgress ? pfnProgress : GDALDummyProgress;
diff -urN gdal-3.4.0-orig/alg/contour.cpp gdal-3.4.0/alg/contour.cpp
--- gdal-3.4.0-orig/alg/contour.cpp	2021-11-04 19:57:05 +0800
+++ gdal-3.4.0/alg/contour.cpp	2021-11-16 12:21:06 +0800
@@ -520,7 +520,7 @@
  *
  * @return CE_None on success or CE_Failure if an error occurs.
  */
-CPLErr GDALContourGenerateEx( GDALRasterBandH hBand, void *hLayer,
+CPLErr CPL_DLL GDALContourGenerateEx( GDALRasterBandH hBand, void *hLayer,
                                       CSLConstList options,
                                       GDALProgressFunc pfnProgress, void *pProgressArg )
 {
diff -urN gdal-3.4.0-orig/alg/viewshed.cpp gdal-3.4.0/alg/viewshed.cpp
--- gdal-3.4.0-orig/alg/viewshed.cpp	2021-11-04 19:57:05 +0800
+++ gdal-3.4.0/alg/viewshed.cpp	2021-11-16 12:20:55 +0800
@@ -199,7 +199,7 @@
  * @since GDAL 3.1
  */
 
-GDALDatasetH GDALViewshedGenerate(GDALRasterBandH hBand,
+GDALDatasetH CPL_DLL GDALViewshedGenerate(GDALRasterBandH hBand,
                             const char* pszDriverName,
                             const char* pszTargetRasterName,
                             CSLConstList papszCreationOptions,
