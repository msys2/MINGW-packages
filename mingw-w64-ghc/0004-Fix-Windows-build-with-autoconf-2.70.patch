From bcaa36c4277dc577863132da2f95645715e2a15e Mon Sep 17 00:00:00 2001
From: Sylvain Henry <sylvain@haskus.fr>
Date: Mon, 22 Feb 2021 18:03:40 +0100
Subject: [PATCH] Fix Windows build with autoconf >=2.70 (#19189)

---
 hadrian/src/Settings/Builders/Cabal.hs |    2 +-
 libraries/base/configure.ac            |    6 +-
 libraries/ghc-bignum/configure.ac      |    4 -
 rules/build-package-data.mk            |    2 -
 8 files changed, 2 insertions(+), 12 deletions(-)

diff --git a/hadrian/src/Settings/Builders/Cabal.hs b/hadrian/src/Settings/Builders/Cabal.hs
index f101b44d46..5996749536 100644
--- a/hadrian/src/Settings/Builders/Cabal.hs
+++ b/hadrian/src/Settings/Builders/Cabal.hs
@@ -127,7 +127,7 @@ configureArgs = do
         , conf "--with-gmp-includes"      $ arg =<< getSetting GmpIncludeDir
         , conf "--with-gmp-libraries"     $ arg =<< getSetting GmpLibDir
         , conf "--with-curses-libraries"  $ arg =<< getSetting CursesLibDir
-        , flag CrossCompiling ? (conf "--host" $ arg =<< getSetting TargetPlatformFull)
+        , conf "--host"                   $ arg =<< getSetting TargetPlatformFull
         , conf "--with-cc" $ arg =<< getBuilderPath . (Cc CompileC) =<< getStage
         , notStage0 ? (arg =<< ("--ghc-option=-ghcversion-file=" ++) <$> expr ((-/-) <$> topDirectory <*> ghcVersionH stage))]
 
diff --git a/libraries/base/configure.ac b/libraries/base/configure.ac
index 4bc2af5f2d..68295563af 100644
--- a/libraries/base/configure.ac
+++ b/libraries/base/configure.ac
@@ -6,16 +6,12 @@ AC_CONFIG_SRCDIR([include/HsBase.h])
 
 AC_CONFIG_HEADERS([include/HsBaseConfig.h include/EventConfig.h])
 
-AC_CANONICAL_BUILD
-AC_CANONICAL_HOST
-AC_CANONICAL_TARGET
-
 AC_PROG_CC
 dnl make extensions visible to allow feature-tests to detect them lateron
 AC_USE_SYSTEM_EXTENSIONS
 
 AC_MSG_CHECKING(for WINDOWS platform)
-case $host in
+case $host_alias in
     *mingw32*|*mingw64*|*cygwin*|*msys*)
         WINDOWS=YES;;
     *)
diff --git a/libraries/ghc-bignum/configure.ac b/libraries/ghc-bignum/configure.ac
index b237978740..4ae9e64044 100644
--- a/libraries/ghc-bignum/configure.ac
+++ b/libraries/ghc-bignum/configure.ac
@@ -4,13 +4,9 @@ AC_INIT([GHC BigNum library], [1.0], [libraries@haskell.org], [ghc-bignum])
 # Safety check: Ensure that we are in the correct source directory.
 AC_CONFIG_SRCDIR([cbits/gmp_wrappers.c])
 
-AC_CANONICAL_TARGET
-
-AC_PROG_CC
 dnl make extensions visible to allow feature-tests to detect them lateron
 AC_USE_SYSTEM_EXTENSIONS
 
-
 dnl--------------------------------------------------------------------
 dnl * Deal with arguments telling us gmp is somewhere odd
 dnl--------------------------------------------------------------------
diff --git a/rules/build-package-data.mk b/rules/build-package-data.mk
index e2a98082d2..b4bb84cb47 100644
--- a/rules/build-package-data.mk
+++ b/rules/build-package-data.mk
@@ -109,9 +109,7 @@ ifneq "$$(CURSES_LIB_DIRS)" ""
 $1_$2_CONFIGURE_OPTS += --configure-option=--with-curses-libraries="$$(CURSES_LIB_DIRS)"
 endif
 
-ifeq "$$(CrossCompiling)" "YES"
 $1_$2_CONFIGURE_OPTS += --configure-option=--host=$(TargetPlatformFull)
-endif
 
 ifeq "$3" "0"
 $1_$2_CONFIGURE_OPTS += $$(BOOT_PKG_CONSTRAINTS)
-- 
2.30.1

