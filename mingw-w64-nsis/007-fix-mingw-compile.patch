diff -urN nsis-3.08-src-orig/Contrib/AdvSplash/SConscript nsis-3.08-src/Contrib/AdvSplash/SConscript
--- nsis-3.08-src-orig/Contrib/AdvSplash/SConscript	2005-05-04 01:31:56.000000000 +0800
+++ nsis-3.08-src/Contrib/AdvSplash/SConscript	2022-02-13 22:06:23.325806400 +0800
@@ -2,6 +2,8 @@
 
 files = Split("""
 	advsplash.c
+	memcpy.c
+	memset.c
 """)
 
 libs = Split("""
diff -urN nsis-3.08-src-orig/Contrib/VPatch/Source/GenPat/POSIXUtil.cpp nsis-3.08-src/Contrib/VPatch/Source/GenPat/POSIXUtil.cpp
--- nsis-3.08-src-orig/Contrib/VPatch/Source/GenPat/POSIXUtil.cpp	2022-02-10 18:47:42.422278500 +0800
+++ nsis-3.08-src/Contrib/VPatch/Source/GenPat/POSIXUtil.cpp	2022-02-13 19:04:25.428788800 +0800
@@ -41,6 +41,7 @@
 #endif
 
 #ifdef __WIN32__     /* The Windows way of getting a temp file needs windows.h*/
+  #define WIN32_LEAN_AND_MEAN
   #include <windows.h>
 #endif
 
diff -urN nsis-3.08-src-orig/Contrib/VPatch/Source/GenPat/SConscript nsis-3.08-src/Contrib/VPatch/Source/GenPat/SConscript
--- nsis-3.08-src-orig/Contrib/VPatch/Source/GenPat/SConscript	2012-11-11 11:12:50.000000000 +0800
+++ nsis-3.08-src/Contrib/VPatch/Source/GenPat/SConscript	2022-02-14 00:20:30.841463700 +0800
@@ -18,4 +18,4 @@
 
 Import('BuildUtil')
 
-BuildUtil(target, files, libs, flags = ['$EXCEPTION_FLAG'], cross_platform = True, cli = True)
+BuildUtil(target, files, libs, flags = ['$EXCEPTION_FLAG', '-DNOCRYPT', '-DNOGDI', '-DNOSHLWAPI'], cross_platform = True, cli = True)
diff -urN nsis-3.08-src-orig/Contrib/nsDialogs/SConscript nsis-3.08-src/Contrib/nsDialogs/SConscript
--- nsis-3.08-src-orig/Contrib/nsDialogs/SConscript	2014-02-10 02:36:53.000000000 +0800
+++ nsis-3.08-src/Contrib/nsDialogs/SConscript	2022-02-13 22:06:13.840989700 +0800
@@ -6,6 +6,8 @@
 	nsDialogs.c
 	nsDialogs.def
 	rtl.c
+	memcpy.c
+	memset.c
 """)
 
 resources = Split("""
diff -urN nsis-3.08-src-orig/SConstruct nsis-3.08-src/SConstruct
--- nsis-3.08-src-orig/SConstruct	2021-01-16 00:31:10.000000000 +0800
+++ nsis-3.08-src/SConstruct	2022-02-14 00:19:53.124306400 +0800
@@ -792,6 +790,7 @@
 			env.Append(LINKFLAGS = env['SUBSYS_CON'])
 		else:
 			env.Append(LINKFLAGS = env['SUBSYS_WIN'])
+		env.Append(LINKFLAGS = ['-static'])
 
 	AddEnvStandardFlags(env, defines, flags, libs, entry, nodeflib)
 
diff -urN nsis-3.08-src-orig/Source/7zip/Common/MyCom.h nsis-3.08-src/Source/7zip/Common/MyCom.h
--- nsis-3.08-src-orig/Source/7zip/Common/MyCom.h	2022-02-10 18:47:31.885675900 +0800
+++ nsis-3.08-src/Source/7zip/Common/MyCom.h	2022-02-12 19:27:07.502766800 +0800
@@ -171,8 +171,8 @@
 
 #define MY_ADDREF_RELEASE \
 STDMETHOD_(ULONG, AddRef)() { return ++__m_RefCount; } \
-STDMETHOD_(ULONG, Release)() { if (--__m_RefCount != 0)  \
-  return __m_RefCount; delete this; return 0; }
+STDMETHOD_(ULONG, Release)() { {if (--__m_RefCount != 0)  \
+  return __m_RefCount;} delete this; return 0; }
 
 #define MY_UNKNOWN_IMP_SPEC(i) \
   MY_QUERYINTERFACE_BEGIN \
diff -urN nsis-3.08-src-orig/Source/Platform.h nsis-3.08-src/Source/Platform.h
--- nsis-3.08-src-orig/Source/Platform.h	2022-02-10 18:47:32.263697500 +0800
+++ nsis-3.08-src/Source/Platform.h	2022-02-14 00:20:04.141936500 +0800
@@ -39,7 +39,6 @@
 #include <commctrl.h>
 #include <shellapi.h>
 #include <shlwapi.h>
-#include <shlobj.h>
 #else
 #  include <stdint.h>
 #  ifndef EXEHEAD
@@ -347,8 +346,11 @@
 
 // shell folders
 
-#ifdef _WIN32
+#if defined(_WIN32) && defined(EXEHEAD)
 #  include <shlobj.h>
+#ifndef SHGFP_TYPE_CURRENT
+  #define SHGFP_TYPE_CURRENT 0
+#endif
 #endif
 
 #ifndef CSIDL_FLAG_CREATE
@@ -488,10 +490,6 @@
 #  define CSIDL_CDBURN_AREA 0x3B
 #endif
 
-#ifndef SHGFP_TYPE_CURRENT
-  #define SHGFP_TYPE_CURRENT 0
-#endif
-
 // other shell stuff
 
 #ifndef SHACF_FILESYSTEM
diff -urN nsis-3.08-src-orig/Source/SConscript nsis-3.08-src/Source/SConscript
--- nsis-3.08-src-orig/Source/SConscript	2021-08-19 07:48:20.000000000 +0800
+++ nsis-3.08-src/Source/SConscript	2022-02-12 19:27:07.414761800 +0800
@@ -53,8 +53,6 @@
 libs = Split("""
 	gdi32
 	user32
-	pthread
-	iconv
 	shlwapi
 	oleaut32
 	version
diff -urN nsis-3.08-src-orig/Source/Tests/SConscript nsis-3.08-src/Source/Tests/SConscript
--- nsis-3.08-src-orig/Source/Tests/SConscript	2019-02-11 04:45:40.000000000 +0800
+++ nsis-3.08-src/Source/Tests/SConscript	2022-02-12 19:31:34.356030000 +0800
@@ -68,10 +68,7 @@
 """)
 
 extralibs = Split("""
-	dl
 	gdi32
-	iconv
-	pthread
 	user32
 	oleaut32
 """)
diff -urN nsis-3.08-src-orig/Source/exehead/SConscript nsis-3.08-src/Source/exehead/SConscript
--- nsis-3.08-src-orig/Source/exehead/SConscript	2020-06-30 07:08:12.000000000 +0800
+++ nsis-3.08-src/Source/exehead/SConscript	2022-02-13 22:05:52.141351600 +0800
@@ -7,6 +7,8 @@
 	plugin.c
 	Ui.c
 	util.c
+	memcpy.c
+	memset.c
 	#Source/crc32.c
 """)
 
@@ -50,6 +52,7 @@
 
 ### Defines
 
+env.Append(CXXFLAGS = ['-std=c++11'])
 env.Append(CPPDEFINES = ['EXEHEAD'])
 env.Append(CPPDEFINES = ['WIN32_LEAN_AND_MEAN'])
 env.Append(CPPDEFINES = ['_WIN32_IE=0x0500'])
diff -urN nsis-3.08-src-orig/Source/build.cpp nsis-3.08-src/Source/build.cpp
--- nsis-3.08-src-orig/Source/build.cpp	2022-02-10 18:47:42.561286500 +0800
+++ nsis-3.08-src/Source/build.cpp	2022-02-12 04:01:03.786358200 +0800
@@ -3714,7 +3716,7 @@
     }
   };
   size_t io[] = { false, (size_t) path, pathcap }, cb;
-  TinyGrowBuf inputbuf((IGrowBuf::size_type) (cb = FIELD_OFFSET(PROMPT_FILEPATH_DATA, Path[pathcap])));
+  TinyGrowBuf inputbuf((IGrowBuf::size_type) (cb = FIELD_OFFSET(PROMPT_FILEPATH_DATA, Path[sizeof(UINT)])));
   PROMPT_FILEPATH_DATA *p = (PROMPT_FILEPATH_DATA*) inputbuf.get();
   p->Platform = (sizeof(void*) * 8) | sizeof(TCHAR), p->Reserved = 0;
   _tcscpy(p->Path, path);
