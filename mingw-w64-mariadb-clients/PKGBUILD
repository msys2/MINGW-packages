# Maintainer: Kreijstal <kreijstal@hotmail.com>

_realname=mariadb-clients
pkgbase="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgname="${pkgbase}"
pkgver=12.0.2
pkgrel=2
pkgdesc="MariaDB client tools (mingw-w64)"
url="https://mariadb.org/"
license=('spdx:GPL-2.0-only')
arch=('any')
mingw_arch=('mingw64' 'ucrt64')
depends=(
  "${MINGW_PACKAGE_PREFIX}-openssl"
  "${MINGW_PACKAGE_PREFIX}-zlib"
  "${MINGW_PACKAGE_PREFIX}-pcre2"
  "${MINGW_PACKAGE_PREFIX}-libmariadbclient"
  "${MINGW_PACKAGE_PREFIX}-icu"
  "${MINGW_PACKAGE_PREFIX}-curl"
)
makedepends=(
  "${MINGW_PACKAGE_PREFIX}-cc"
  "${MINGW_PACKAGE_PREFIX}-cmake"
  "${MINGW_PACKAGE_PREFIX}-ninja"
  "${MINGW_PACKAGE_PREFIX}-pkgconf"
)
source=(
  "${_realname}-${pkgver}.tar.gz::https://github.com/MariaDB/server/archive/refs/tags/mariadb-${pkgver}.tar.gz"
  "0001-MinGW-UCRT64-client-only-build-using-system-Connecto.patch"
)
sha256sums=('f708c5c1cbb810c88442ad48b16ad94341c037df6cf87a0c0c635bb032973e49'
            'ecf6dbcfb116e8a79941f7d751aac9bdd43c19d0ec55fe16bd038873bfd6e3a6')

_builddir="build-${MSYSTEM_CARCH:-mingw}"

prepare() {
  cd "${srcdir}/server-mariadb-${pkgver}"
  patch -p1 -i "${srcdir}/0001-MinGW-UCRT64-client-only-build-using-system-Connecto.patch"
}

build() {
  cd "${srcdir}/server-mariadb-${pkgver}"
  # Prevent MSYS path conversion for CMAKE_INSTALL_PREFIX to keep a POSIX prefix
  MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=" \
  "${MINGW_PREFIX}/bin/cmake.exe" -S . -B "${_builddir}" \
    -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX} \
    -DINSTALL_LIBDIR=lib \
    -DWITHOUT_SERVER=ON \
    -DWITHOUT_AUTHENTICATION_WINDOWS_CLIENT=ON \
    -DPLUGIN_AUTHENTICATION_WINDOWS_CLIENT=NO \
    -DUSE_SYSTEM_LIBMARIADB=ON \
    -DUPDATE_SUBMODULES=OFF \
    -DPLUGIN_AUTH_ED25519=NO \
    -DWITH_AUTH_ED25519=OFF \
    -DINSTALL_RUNTIME_DEPENDENCIES=OFF \
    -DWITH_VECTOR_MHNSW=OFF \
    -DWITH_UNIT_TESTS=OFF

  # Build client tools that are installed by the Client component
  "${MINGW_PREFIX}/bin/cmake.exe" --build "${_builddir}" --parallel --target \
    mariadb mariadb-dump mariadb-admin mariadb-check mariadb-show \
    mariadb-plugin mariadb-slap mariadb-import mariadb-upgrade \
    mariadb-conv my_print_defaults replace
}

check() {
  :
}

package() {
  cd "${srcdir}/server-mariadb-${pkgver}"
  # Install only client runtime bits; avoid Development (server headers) component
  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake.exe" --install "${_builddir}" --component Client
  # Install client plugins component (if present)
  DESTDIR="${pkgdir}" "${MINGW_PREFIX}/bin/cmake.exe" --install "${_builddir}" --component ClientPlugins

  install -Dm644 COPYING "${pkgdir}${MINGW_PREFIX}/share/licenses/${pkgname}/COPYING"
}

