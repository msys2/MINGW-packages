# Maintainer: Taozuhong <taozuhong@hotmail.com>

_realname=arrow-adbc-glib
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=22
pkgrel=2
pkgdesc="ADBC libraries for Arrow-native access to databases for GLib.(mingw-w64)"
arch=('any')
mingw_arch=('mingw64' 'ucrt64' 'clang64' 'clangarm64')
url="https://github.com/apache/arrow-adbc"
msys2_repository_url='https://github.com/apache/arrow-adbc'
license=('Apache-2.0')
depends=("${MINGW_PACKAGE_PREFIX}-glib2"
         "${MINGW_PACKAGE_PREFIX}-arrow-adbc")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc"
		"${MINGW_PACKAGE_PREFIX}-vala"
    "${MINGW_PACKAGE_PREFIX}-cmake"
		"${MINGW_PACKAGE_PREFIX}-meson"
    "${MINGW_PACKAGE_PREFIX}-ninja"
    "${MINGW_PACKAGE_PREFIX}-arrow"
    "${MINGW_PACKAGE_PREFIX}-nanoarrow"
		"${MINGW_PACKAGE_PREFIX}-gobject-introspection"
    "${MINGW_PACKAGE_PREFIX}-pkgconf")
options=('staticlibs' 'strip' 'emptydirs')
source=("https://github.com/apache/arrow-adbc/archive/refs/tags/apache-arrow-adbc-${pkgver}.tar.gz"
			  "0001-Update-gir-version-with-pkgconfig.patch")
sha256sums=('55e4129a76ead89a868fa9267e8be2ec7fcb7c41ac44a55e70c2d3591fa0b227'
						'14a9c7d8479748080e8d6ea3d877972dc2ba3cc85f7cf06b43ceb7670df412b1')

prepare() {
  cd "arrow-adbc-apache-arrow-adbc-${pkgver}"

  patch -p1 -i "${srcdir}/0001-Update-gir-version-with-pkgconfig.patch"
}

build() {
  [[ -d ${srcdir}/build-${MINGW_CHOST} ]] && rm -rf ${srcdir}/build-${MINGW_CHOST}
  mkdir -p ${srcdir}/build-${MINGW_CHOST} && cd ${srcdir}/build-${MINGW_CHOST}  

  declare -a _meson_extra_config
  if check_option "debug" "n"; then
    _meson_extra_config+=("--buildtype=release")
  else
    _meson_extra_config+=("--buildtype=debug")
  fi
  
  MSYS2_ARG_CONV_EXCL="--prefix=" \
  ${MINGW_PREFIX}/bin/meson.exe setup \
    --prefix="${MINGW_PREFIX}" \
	-Dvapi=true \
    --buildtype=plain \
    --default-library=both \
    --wrap-mode=nodownload \
    ../arrow-adbc-apache-arrow-adbc-${pkgver}/glib

  ${MINGW_PREFIX}/bin/meson compile
}

package() {
  cd ${srcdir}/build-${MINGW_CHOST} 
  DESTDIR="${pkgdir}" ${MINGW_PREFIX}/bin/meson install
}