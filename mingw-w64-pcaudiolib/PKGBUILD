# Maintainer: Michael Rans <rans@email.com>

_realname=pcaudiolib
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=1.3+e907571
pkgrel=1
pkgdesc="A portable cross-platform audio library"
arch=('any')
mingw_arch=('mingw64' 'ucrt64' 'clang64' 'clangarm64')
url="https://github.com/espeak-ng/pcaudiolib"
license=("GPL-3.0-or-later")
makedepends=("${MINGW_PACKAGE_PREFIX}-cc" "${MINGW_PACKAGE_PREFIX}-autotools" "git" "patch" "rsync")
depends=("${MINGW_PACKAGE_PREFIX}-cc-libs")
_commit=e907571bad7dee296fb56a409a0f7c5a0c57d38a
source=("git+https://github.com/espeak-ng/${_realname}#commit=${_commit}"
		"MSYS2.patch")
sha256sums=('932932e469e1fe599b4a1834cd4c64ffe00a254cf421c1a0d448779407887c5b'
            'afcdd8cf828c474f49271a6eca7dac28eb5e274ff63c90c8415b640e66290492')

pkgver() {
  cd "${srcdir}/${_realname}"
  # Use short hash
  printf "%s" "1.3+$(git rev-parse --short HEAD)"
}

prepare() {
  cd "${srcdir}/${_realname}"
  patch -p1 -i ${srcdir}/MSYS2_MinGW64.patch
  ./autogen.sh
}

build() {
  rsync --recursive --times --links "${srcdir}/${_realname}/src/include"/* "${srcdir}/build-${MSYSTEM}"
  mkdir -p "${srcdir}/build-${MSYSTEM}" && cd "${srcdir}/build-${MSYSTEM}"

  "../${_realname}/configure" \
    --prefix=${MINGW_PREFIX} \
    --build=${MINGW_CHOST} \
    --host=${MINGW_CHOST}

  make LIBTOOLFLAGS=-v
}

check() {
  cd "${srcdir}/build-${MSYSTEM}"
}

package() {
  cd "${srcdir}/build-${MSYSTEM}"

  make DESTDIR="${pkgdir}" install
  
  install -Dm644 "${srcdir}/${_realname}/COPYING" "${pkgdir}${MINGW_PREFIX}/share/licenses/${_realname}/COPYING" 
}
